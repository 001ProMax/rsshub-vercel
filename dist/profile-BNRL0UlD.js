import{__dirname as e,init_esm_shims as t}from"./esm-shims-CtP6w_ML.js";import{config as n}from"./config-DYqAlsU3.js";import"./logger-BlLSmUdl.js";import"./proxy-kot7LoOQ.js";import{cache_default as r}from"./cache-CvppK6AM.js";import{art as i}from"./render-DE4LRFBD.js";import{puppeteer_default as a}from"./puppeteer-DQCLzTv0.js";import o from"node:path";import{load as s}from"cheerio";import*as c from"chrono-node";const l=async(e,t,n=!1)=>{let r=await t.newPage(),i=n?[`document`,`script`,`xhr`]:[`document`];await r.setRequestInterception(!0),r.on(`request`,e=>{i.includes(e.resourceType())?e.continue():e.abort()}),await r.goto(e,{waitUntil:`domcontentloaded`}),await r.waitForSelector(`.wrapper`),n&&(await r.$eval(`.show_stories_button`,e=>e.click()),await r.waitForSelector(`.stories_container .content`));let a=await r.evaluate(()=>document.documentElement.innerHTML);return await r.close(),a};t();function u(e){let t=s(e),n=``;return t(`img,video`).each((e,r)=>{let i=r.name,a=t(r),o=a.attr(`poster`);n+=(()=>o?`<img src='${o}' alt='video poster'>`:i===`img`?a.toString():``)()}),n}const d={path:`/profile/:id/:type?/:functionalFlag?`,categories:[`social-media`],example:`/picuki/profile/stefaniejoosten`,parameters:{id:`Instagram user id`,type:`Type of profile page (profile or tagged)`,functionalFlag:`functional flag, see the table below
| functionalFlag | Video embedding                         | Fetching Instagram Stories |
| -------------- | --------------------------------------- | -------------------------- |
| 0              | off, only show video poster as an image | off                        |
| 1 (default)    | on                                      | off                        |
| 10             | on                                      | on                         |
`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!0,supportBT:!1,supportPodcast:!1,supportScihub:!1},radar:[{source:[`www.picuki.com/profile/:id`],target:`/profile/:id`},{source:[`www.picuki.com/profile-tagged/:id`],target:`/profile/:id/tagged`}],name:`User Profile - Picuki`,maintainers:[`hoilc`,`Rongronggg9`,`devinmugen`,`NekoAria`],handler:f,description:`
::: warning
  Instagram Stories do not have a reliable guid. It is possible that your RSS reader show the same story more than once.
  Though, every Story expires after 24 hours, so it may be not so serious.
:::`};async function f(t){let d=await a(),f=t.req.param(`id`),p=t.req.param(`type`)??`profile`,m=t.req.param(`functionalFlag`)??`1`,h=m!==`0`,g=m===`10`,_=`https://www.picuki.com/${p===`tagged`?`profile-tagged`:`profile`}/${f}`,v=`picuki-${f}-${p}-${g}`,y=await r.tryGet(v,()=>l(_,d,g),n.cache.routeExpire,!1),b=s(y),x=b(`.profile-name-bottom`).text(),S=p===`tagged`?`${x} (@${f}) tagged posts - Picuki`:`${x} (@${f}) public posts - Picuki`,C=b(`.profile-avatar > img`).attr(`src`),w=b(`.profile-description`).text(),T=b(`ul.box-photos [data-s="media"]`).toArray(),E=[],D;if(g){let t=b(`.stories_wrapper`);if(t.length){let n=b(t).find(`.item`).toArray().map(t=>{let n=b(t),r=n.find(`.stories_count`),a=r.length?r.text():``,s=c.parseDate(a)||new Date,l=n.find(`.launchLightbox`),u=l.attr(`data-video-poster`),d=l.attr(`href`),p=l.attr(`data-post-type`),m=l.attr(`data-origin`),h=n.find(`.stories_background`),g=h?.css(`background-image`)?.match(/url\('?(.*)'?\)/),_=g?.[1];return p===`video`?D=i(o.join(e,`templates/video-91fd1e96.art`),{videoSrcs:[d,m].filter(Boolean),videoPoster:u??_??``}):p===`image`&&(D=`<img src="${d??u??_??``}" alt="Instagram Story">`),{title:a?`Instagram Story: ${a}`:`Instagram Story`,author:`@${f}`,description:D,link:d,pubDate:s}});n.length&&(E=n)}}async function O(t){let n=()=>l(t,d),a=await r.tryGet(t,n);Object.prototype.toString.call(a)===`[object Object]`&&(a=await n(),await r.set(t,a));let c=s(a),u=``;return c(`.single-photo img`).each((e,t)=>{u+=c(t).toString()}),c(`.single-photo video`).each((t,n)=>{let r=c(n),a=r.attr(`src`);a===void 0&&(a=r.children().attr(`src`));let s=r.attr(`poster`),l=r.parent().attr(`onclick`);if(l){let e=/window\.open\('([^']*)'/,t=e.exec(l);l=t?.[1]}u+=i(o.join(e,`templates/video-91fd1e96.art`),{videoSrcs:[a,l].filter(Boolean),videoPoster:s})}),u}return E=[...E,...await Promise.all(T.map(async t=>{let n=b(t),r=n.find(`.photo > a`).attr(`href`),a=n.find(`.time`),s=a?.text()?c.parseDate(a.text())??new Date:new Date,l=await O(r),d=n.find(`.photo-action-description`).text().trim().replaceAll(/[^\S\n]+/g,` `).replaceAll(/((?<=\n|^)[^\S\n])|([^\S\n](?=\n|$))/g,``),p=d.replaceAll(`
`,` `)||`Untitled`,m=i(o.join(e,`templates/post-d917f5bb.art`),{media:h?l:u(l),desc:d,locationLink:n.find(`.photo-location .icon-globe-alt a`)});return{title:p,author:`@${f}`,description:m,link:r,pubDate:s}}))],await d.close(),{title:S,link:_,image:C,description:w,item:E}}export{d as route};