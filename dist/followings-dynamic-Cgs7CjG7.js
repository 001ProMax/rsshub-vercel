import"./esm-shims-CtP6w_ML.js";import{config as e}from"./config-DYqAlsU3.js";import"./logger-BlLSmUdl.js";import"./proxy-kot7LoOQ.js";import"./ofetch-CWQqZcqz.js";import"./helpers-RrXnNmv1.js";import"./cache-CvppK6AM.js";import"./render-DE4LRFBD.js";import"./md5-BJqXla8f.js";import{got_default as t}from"./got-BwctkUCD.js";import{config_not_found_default as n}from"./config-not-found-QwO11ree.js";import"./puppeteer-DQCLzTv0.js";import{fallback as r,queryToBoolean as i}from"./readable-social-CZfNaCIB.js";import{utils_default as a}from"./utils-CsTdEpjv.js";import{cache_default$1 as o}from"./cache-COOjRm1i.js";import s from"json-bigint";import c from"querystring";const l={path:`/followings/dynamic/:uid/:routeParams?`,categories:[`social-media`],example:`/bilibili/followings/dynamic/109937383`,parameters:{uid:`用户 id, 可在 UP 主主页中找到`,routeParams:`
| 键         | 含义                              | 接受的值       | 默认值 |
| ---------- | --------------------------------- | -------------- | ------ |
| showEmoji  | 显示或隐藏表情图片                | 0/1/true/false | false  |
| embed      | 默认开启内嵌视频                  | 0/1/true/false |  true  |
| useAvid    | 视频链接使用 AV 号 (默认为 BV 号) | 0/1/true/false | false  |
| directLink | 使用内容直链                      | 0/1/true/false | false  |
| hideGoods  | 隐藏带货动态                      | 0/1/true/false | false  |

用例：\`/bilibili/followings/dynamic/2267573/showEmoji=1&embed=0&useAvid=1\``},features:{requireConfig:[{name:`BILIBILI_COOKIE_*`,description:"BILIBILI_COOKIE_{uid}: 用于用户关注动态系列路由，对应 uid 的 b 站用户登录后的 Cookie 值，`{uid}` 替换为 uid，如 `BILIBILI_COOKIE_2267573`，获取方式：\n    1.  打开 [https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?uid=0&type=8](https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?uid=0&type=8)\n    2.  打开控制台，切换到 Network 面板，刷新\n    3.  点击 dynamic_new 请求，找到 Cookie\n    4.  视频和专栏，UP 主粉丝及关注只要求 `SESSDATA` 字段，动态需复制整段 Cookie"}],requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`用户关注动态`,maintainers:[`TigerCubDen`,`JimenezLi`],handler:u,description:`::: warning
  用户动态需要 b 站登录后的 Cookie 值，所以只能自建，详情见部署页面的配置模块。
:::`};async function u(l){let u=String(l.req.param(`uid`)),d=c.parse(l.req.param(`routeParams`)),f=r(void 0,i(d.showEmoji),!1),p=r(void 0,i(d.embed),!0),m=r(void 0,i(d.displayArticle),!1),h=await o.getUsernameFromUID(u),g=e.bilibili.cookies[u];if(g===void 0)throw new n(`缺少对应 uid 的 Bilibili 用户登录后的 Cookie 值`);let _=await t({method:`get`,url:`https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?uid=${u}&type_list=268435455`,headers:{Referer:`https://space.bilibili.com/${u}/`,Cookie:g}});if(_.data.code===-6)throw new n(`对应 uid 的 Bilibili 用户的 Cookie 已过期`);if(_.data.code===41e5)throw new n(`对应 uid 的 Bilibili 用户 请求失败`);let v=s.parse(_.body).data.cards,y=e=>e&&(e.title||e.description||e.content||e.vest&&e.vest.content)||``,b=e=>e.dynamic||e.desc||e.description||e.content||e.summary||(e.vest&&e.vest.content)+(e.sketch&&`<br>${e.sketch.title}<br>${e.sketch.desc_text}`)||e.intro||``,x=e=>e&&(e.apiSeasonInfo&&e.apiSeasonInfo.title&&`//转发自: ${e.apiSeasonInfo.title}`)+(e.index_title&&`<br>${e.index_title}`)||``,S=e=>e.uname||e.author&&e.author.name||e.upper&&e.upper.name||e.user&&(e.user.uname||e.user.name)||e.owner&&e.owner.name||``,C=e=>e.title?`${e.title}<br>`:``,w=e=>{if(!p)return``;let t=e?.aid,n=e?.bvid;return t===void 0&&n===void 0?``:a.renderUGCDescription(p,``,``,t,void 0,n)},T=e=>{let t=``;if(e.pictures)for(let n=0;n<e.pictures.length;n++)t+=`<img src="${e.pictures[n].img_src}">`;if(e.image_urls)for(let n=0;n<e.image_urls.length;n++)t+=`<img src="${e.image_urls[n]}">`;return e.pic&&(t+=`<img src="${e.pic}">`),e.cover&&e.cover.unclipped?t+=`<img src="${e.cover.unclipped}">`:e.cover&&(t+=`<img src="${e.cover}">`),e.sketch&&e.sketch.cover_url&&(t+=`<img src="${e.sketch.cover_url}">`),t},E=await Promise.all(v.map(async e=>{let t=s.parse(e.card),n=t.apiSeasonInfo||(y(t.item)?t.item:t),r=t.origin||null,i=``;i+=T(n),r&&(i+=T(r.item||r));let a=``;n.video_playurl&&(a+=`<video width="${n.width}" height="${n.height}" controls><source src="${unescape(n.video_playurl).replace(/^http:/,`https:`)}"><source src="${unescape(n.video_playurl)}"></video>`);let c=``;n.dynamic_id?c=`https://t.bilibili.com/${n.dynamic_id}`:e.desc?.dynamic_id&&(c=`https://t.bilibili.com/${e.desc.dynamic_id}`);let l=b(n);if(e.display&&e.display.emoji_info&&f){let t=e.display.emoji_info.emoji_details;for(let e of t)l=l.replaceAll(RegExp(`\\${e.text}`,`g`),`<img alt="${e.text}" src="${e.url}"style="margin: -1px 1px 0px; display: inline-block; width: 20px; height: 20px; vertical-align: text-bottom;" title="" referrerpolicy="no-referrer">`)}let d=``;return e.desc?.user_profile&&(d=e.desc.user_profile.info.uname),n.image_urls&&m&&(l=(await o.getArticleDataFromCvid(n.id,u)).description),{title:y(n),author:d,description:(()=>{let e=t.new_desc||l||b(n),o=r&&S(r)?`<br><br>//转发自: @${S(r)}: ${C(r.item||r)}${b(r.item||r)}`:x(r),s=i?`<br>${i}`:``,c=a?`<br>${a}`:``;return`${e}${o}${w(n)}${w(r)}${s}${c}`})(),pubDate:new Date(e.desc?.timestamp*1e3).toUTCString(),link:c}}));return{title:`${h} 关注的动态`,link:`https://t.bilibili.com`,description:`${h} 关注的动态`,item:E}}export{l as route};