import"./esm-shims-DtWyl6zt.js";import"./config-C9m9eBw5.js";import"./logger-CC3afzWM.js";import"./proxy-Br-Rb_Qy.js";import"./dist-CKN2M7CD.js";import"./helpers-DzX-lcQO.js";import"./cache-Sft5n2jg.js";import"./render-CxhTJIsl.js";import"./md5-4BNsOP-F.js";import"./ofetch-CWsaZ4vY.js";import{got_default as e}from"./got-RSSJ34bj.js";import"./puppeteer-uO6s7chG.js";import"./utils-CXWIJDIU.js";import{cache_default as t}from"./cache-CJdNLLau.js";import n from"node:zlib";import{load as r}from"cheerio";const i=e=>{let t=Number.parseInt(e),n=t%60,r=(t-n)/60%60,i=(t-n-60*r)/3600;return`${i}:${r.toString().padStart(2,`0`)}:${n.toString().padStart(2,`0`)}`},a={path:`/video/danmaku/:bvid/:pid?`,categories:[`social-media`],example:`/bilibili/video/danmaku/BV1vA411b7ip/1`,parameters:{bvid:`视频AV号,可在视频页 URL 中找到`,pid:`分P号,不填默认为1`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`视频弹幕`,maintainers:[`Qixingchen`],handler:o};async function o(a){let o=a.req.param(`bvid`),s;o.startsWith(`BV`)||(s=o,o=null);let c=Number(a.req.param(`pid`)||1),l=await t.getCidFromId(s,c,o),u=await t.getVideoNameFromId(s,o),d=`https://www.bilibili.com/video/${o||`av${s}`}`,f=await e.get(`https://comment.bilibili.com/${l}.xml`,{decompress:!1,responseType:`buffer`,headers:{Referer:d}}),p=f.body;p=await((p[0]&15)==8?n.inflateSync(p):n.inflateRawSync(p));let m=[],h=r(p,{xmlMode:!0});return h(`d`).each((e,t)=>{m.push({p:h(t).attr(`p`),text:h(t).text()})}),m=m.toReversed().slice(0,50),{title:`${u} 的 弹幕动态`,link:d,description:`${u} 的 弹幕动态`,item:m.map(e=>({title:`[${i(e.p.split(`,`)[0])}] ${e.text}`,pubDate:new Date(e.p.split(`,`)[4]*1e3).toUTCString(),guid:`${l}-${e.p.split(`,`)[4]}-${e.p.split(`,`)[7]}`,link:d}))}}export{a as route};