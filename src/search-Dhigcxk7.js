import{__dirname as e,init_esm_shims as t}from"./esm-shims-CGUM9TC6.js";import{config as n}from"./config-C9m9eBw5.js";import"./logger-CC3afzWM.js";import{parseDate as r}from"./parse-date-D4osZfpm.js";import"./dist-0j_z2rfc.js";import"./cache-GwMhal7i.js";import{art as i}from"./render-DOz85fGU.js";import"./ofetch-ZUQ1sEMc.js";import{invalid_parameter_default as a}from"./invalid-parameter-CUJdROXf.js";import{config_not_found_default as o}from"./config-not-found-BVqhRP9D.js";import{queryToBoolean as s}from"./readable-social-D4KJOlrJ.js";import{VALID_HAS_TYPES as c,baseUrl as l,getGuild as u,searchGuildMessages as d}from"./discord-api-CB-DNw9D.js";import f from"node:path";t();const p={path:`/search/:guildId/:routeParams`,categories:[`social-media`],example:`/discord/search/302094807046684672/content=friendly&has=image,video`,parameters:{guildId:`Guild ID`,routeParams:`Search parameters, support content, author_id, mentions, has, min_id, max_id, channel_id, pinned`},features:{requireConfig:[{name:`DISCORD_AUTHORIZATION`,description:`Discord authorization header`}],requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`Guild Search`,maintainers:[`NekoAria`],handler:h},m=e=>{let t=new URLSearchParams(e),n=t.get(`has`)?.split(`,`).filter(Boolean),r=n?.filter(e=>c.has(e)),i={content:t.get(`content`)??void 0,author_id:t.get(`author_id`)??void 0,mentions:t.get(`mentions`)??void 0,has:r?.length?r:void 0,min_id:t.get(`min_id`)??void 0,max_id:t.get(`max_id`)??void 0,channel_id:t.get(`channel_id`)??void 0,pinned:t.has(`pinned`)?s(t.get(`pinned`)):void 0};return Object.fromEntries(Object.entries(i).filter(([,e])=>e!==void 0))};async function h(t){let{authorization:s}=n.discord||{};if(!s)throw new o(`Discord RSS is disabled due to the lack of authorization config`);let{guildId:c}=t.req.param(),p=m(t.req.param(`routeParams`));if(!Object.keys(p).length)throw new a(`At least one valid search parameter is required`);let[h,g]=await Promise.all([u(c,s),d(c,s,p)]);if(!g?.messages?.length)return{title:`Search Results - ${h.name}`,link:`${l}/channels/${c}`,item:[],allowEmpty:!0};let _=g.messages.flat().map(t=>({title:t.content.split(`
`)[0]||`(no content)`,description:i(f.join(e,`templates/message-311bc85b.art`),{message:t,guildInfo:h}),author:t.author.global_name??t.author.username,pubDate:r(t.timestamp),updated:t.edited_timestamp?r(t.edited_timestamp):void 0,category:[`#${t.channel_id}`],link:`${l}/channels/${c}/${t.channel_id}/${t.id}`})),v=Object.entries(p).filter(([,e])=>e!==void 0).map(([e,t])=>`${e}:${Array.isArray(t)?t.join(`,`):t}`).join(` `);return{title:`Search "${v}" in ${h.name} - Discord`,link:`${l}/channels/${c}`,item:_,allowEmpty:!0}}export{p as route};