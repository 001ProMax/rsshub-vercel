import"./esm-shims-CGUM9TC6.js";import"./config-C9m9eBw5.js";import"./logger-CC3afzWM.js";import{parseDate as e}from"./parse-date-D4osZfpm.js";import"./dist-0j_z2rfc.js";import"./helpers-nWIDkd0K.js";import{request_in_progress_default as t}from"./request-in-progress-BVwSE1el.js";import{cache_default as n}from"./cache-GwMhal7i.js";import"./ofetch-ZUQ1sEMc.js";import{got_default as r}from"./got-CB83B8oA.js";import{timezone as i}from"./timezone-BrNu6iXe.js";import{wait_default as a}from"./wait-BbnIcMBo.js";import{finishArticleItem as o}from"./wechat-mp-BhyqE9dN.js";import{load as s}from"cheerio";const c=(t,n,r)=>{let a=t.find(n),o=a.text(),s=a.attr(`href`),c=i(e(t.find(r).text(),`YYYY-MM-DD HH:mm`),8);return{title:o,link:s,pubDate:c}},l={path:`/data258/:id?`,radar:[{source:[`mp.data258.com/`,`mp.data258.com/article/category/:id`]}],name:`Unknown`,maintainers:[`Rongronggg9`],handler:u,url:`mp.data258.com/`};async function u(e){if(await n.get(`data258:lock`,!1)===`1`)throw new t(`Another request is in progress, please try again later.`);let i=e.req.param(`id`),l=e.req.query(`limit`)?Number.parseInt(e.req.query(`limit`)):5,u=`https://mp.data258.com`,d=i?`${u}/article/category/${i}`:u,f=await r(d),p=s(f.data),m=p(`head title`).text(),h=p(`meta[name="description"]`).attr(`content`),g=p(`ul.fly-list`),_=g&&g.length?p(g).find(`li`).toArray().map(e=>c(p(e),`h2 a`,`.fly-list-info span`)):p(`ul.jie-row li`).toArray().map(e=>c(p(e),`a.jie-title`,`.layui-hide-xs`));if(_=_.slice(0,l),await n.get(`data258:lock`,!1)===`1`)throw new t(`Another request is in progress, please try again later.`);await n.set(`data258:lock`,`1`,60);let v;for(let e of _){let t=e.link.match(/id=([\da-f]+)/)[1];e.link=e.link.startsWith(`http`)?e.link:`${u}${e.link}`;let i=await n.tryGet(`data258:${t}`,async()=>{try{await a(1e3);let t=await r.get(e.link,{headers:{Referer:d}});if(t.data.includes(`今日浏览次数已达上限`))return v=new r.RequestError(t.data,{},t.request),null;let n=s(t.data),i=n(`script`).filter((e,t)=>n(t).html().includes(`location.href`)).html();return i.match(/location\.href='([^']+)'/)[1]}catch(e){return v=e,null}});if(i)e.link=i;else break}if(await n.set(`data258:lock`,`0`,1),_=_.filter(e=>e.link.match(/^https?:\/\/mp\.weixin\.qq\.com\/s/)),_.length===0&&v)throw v;return await Promise.all(_.map(e=>o(e,!!g))),{title:m,link:d,description:h,item:_}}export{l as route};