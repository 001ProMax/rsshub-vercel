import{__dirname as e,init_esm_shims as t}from"./esm-shims-DtWyl6zt.js";import"./config-C9m9eBw5.js";import"./logger-CC3afzWM.js";import"./dist-CKN2M7CD.js";import"./helpers-DzX-lcQO.js";import{cache_default as n}from"./cache-Sft5n2jg.js";import{art as r}from"./render-CxhTJIsl.js";import{parseDate as i}from"./parse-date-Bgabdhlb.js";import"./ofetch-CWsaZ4vY.js";import{got_default as a}from"./got-RSSJ34bj.js";import o from"node:path";import{load as s}from"cheerio";const c=`https://kemono.cr`,l=`${c}/api/v1`,u={m4a:`audio/mp4`,mp3:`audio/mpeg`,mp4:`video/mp4`};t();const d={path:`/:source?/:id?/:type?`,categories:[`anime`],example:`/kemono`,parameters:{source:`Source, see below, Posts by default`,id:`User id, can be found in URL`,type:`Content type: announcements or fancards`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1,nsfw:!0},radar:[{source:[`kemono.cr/`],target:``},{source:[`kemono.cr/:source/user/:id`],target:`/:source/:id`},{source:[`kemono.cr/:source/user/:id/announcements`],target:`/:source/:id/announcements`},{source:[`kemono.cr/:source/user/:id/fancards`],target:`/:source/:id/fancards`}],name:`Posts`,maintainers:[`nczitzk`,`AiraNadih`],handler:C,description:`Sources

| Posts | Patreon | Pixiv Fanbox | Gumroad | SubscribeStar | DLsite | Discord | Fantia |
| ----- | ------- | ------------ | ------- | ------------- | ------ | ------- | ------ |
| posts | patreon | fanbox       | gumroad | subscribestar | dlsite | discord | fantia |

::: tip
  When \`posts\` is selected as the value of the parameter **source**, the parameter **id** does not take effect.
  There is an optinal parameter **limit** which controls the number of posts to fetch, default value is 25.
  
  Support for announcements and fancards:
  - Use \`/:source/:id/announcements\` to get announcements
  - Use \`/:source/:id/fancards\` to get fancards
:::`};function f(e){if(typeof e!=`string`)return e;try{let t=JSON.parse(e);return typeof t==`string`&&(t=JSON.parse(t)),t}catch{return e}}function p(e,t,n){if(e===`posts`)return`${l}/posts`;if(e===`discord`&&t)return`${l}/discord/channel/lookup/${t}`;if(!t)throw Error(`User ID is required for non-posts sources`);let r=`${l}/${e}/user/${t}`;return n?`${r}/${n}`:`${r}/posts`}function m(e,t,n){if(e===`posts`)return`${c}/posts`;if(e===`discord`&&t)return`${c}/${e}/server/${t}`;if(!t)throw Error(`User ID is required for non-posts sources`);let r=`${c}/${e}/user/${t}`;return n?`${r}/${n}`:r}async function h(e,t){try{let n=`${l}/${e}/user/${t}/profile`,r=await a({method:`get`,url:n});return r.data.name||`Unknown User`}catch{return`Unknown User`}}function g(e){let t=[];if(e.file){let n=f(e.file);n&&typeof n==`object`&&`path`in n&&t.push({name:n.name||`Unnamed File`,path:n.path,extension:_(n.path)})}if(Array.isArray(e.attachments))for(let n of e.attachments){let e=f(n);e&&typeof e==`object`&&`path`in e&&t.push({name:e.name||`Unnamed Attachment`,path:e.path,extension:_(e.path)})}return t}function _(e){return e.replace(/.*\./,``).toLowerCase()}function v(e){let t=s(e),n={};return t(`audio source, video source`).each(function(){let e=t(this).attr(`src`);if(!e)return;let r=_(e),i=u[r];if(i)return n={enclosure_url:new URL(e,c).toString(),enclosure_type:i},!1}),n}async function y(t,s){let l=await Promise.all(t.map(t=>n.tryGet(`discord_${t.id}`,async()=>{let n=await a({method:`get`,url:`${c}/api/v1/discord/channel/${t.id}?o=0`});return n.data.filter(e=>e.content||e.attachments).slice(0,s).map(n=>({title:n.content||`Discord Message`,description:r(o.join(e,`templates/discord-10e8038a.art`),{i:n}),author:`${n.author.username}#${n.author.discriminator}`,pubDate:i(n.published),category:t.name,guid:`kemono:discord:${n.server}:${n.channel}:${n.id}`,link:`https://discord.com/channels/${n.server}/${n.channel}/${n.id}`}))})));return l.flat()}function b(e,t,n,r,a){return e.slice(0,a).map(e=>({title:`Announcement from ${e.published?i(e.published).toDateString():`Unknown Date`}`,description:`<div>${e.content||``}</div>`,author:t,pubDate:i(e.published),guid:`kemono:${n}:${r}:announcement:${e.hash}`,link:`${c}/${n}/user/${r}/announcements`}))}function x(e,t,n,r,a){return e.slice(0,a).map(e=>{let a=`${e.server}${e.path}`;return{title:`Fancard ${e.id}`,description:`<img src="${a}" alt="Fancard ${e.id}" />`,author:t,pubDate:i(e.added),guid:`kemono:${n}:${r}:fancard:${e.id}`,link:a,enclosure_url:a,enclosure_type:e.mime}})}function S(t,n,a){return t.filter(e=>e.content||e.attachments).slice(0,a).map(t=>{let a=g(t),l={...t,files:a},u=r(o.join(e,`templates/source-7bbf197e.art`),{i:l}),d=t.content?`<div>${t.content}</div>`:``,f=s(d),p=s(u)(`img, a, audio, video`).toArray().map(e=>f(e).prop(`outerHTML`)),m=0,h=/downloads\.fanbox\.cc/;f(`a`).each(function(){let e=f(this).attr(`href`);e&&h.test(e)&&(f(this).replaceWith(p[m]||``),m++)}),d=(p[0]||``)+f.html();for(let e of p.slice(m+1))d+=e;return{title:t.title||`Untitled Post`,description:d,author:n,pubDate:i(t.published),guid:`kemono:${t.service}:${t.user}:post:${t.id}`,link:`${c}/${t.service}/user/${t.user}/post/${t.id}`,...v(d)}})}async function C(e){let t=e.req.query(`limit`)?Number.parseInt(e.req.query(`limit`)):25,n=e.req.param(`source`)||`posts`,r=e.req.param(`id`),i=e.req.param(`type`),o=n===`posts`,s=n===`discord`;try{let e=p(n,r,i),l=m(n,r,i),u=await a({method:`get`,url:e}),d=o||s||!r?``:await h(n,r),f=o||s?`${c}/favicon.ico`:`https://img.kemono.cr/icons/${n}/${r}`,g,_;if(s)_=`Posts of ${r} from Discord | Kemono`,g=await y(u.data,t);else if(i===`announcements`)_=`Announcements of ${d} from ${n} | Kemono`,g=b(u.data,d,n,r,t);else if(i===`fancards`)_=`Fancards of ${d} from ${n} | Kemono`,g=x(u.data,d,n,r,t);else{_=o?`Kemono Posts`:`Posts of ${d} from ${n} | Kemono`;let e=o?u.data.posts:u.data;g=S(e,d,t)}return{title:_,image:f,link:l,item:g}}catch(e){throw Error(`Failed to fetch data from Kemono: ${e instanceof Error?e.message:`Unknown error`}`)}}export{d as route};