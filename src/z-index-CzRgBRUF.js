import{__dirname as e,init_esm_shims as t}from"./esm-shims-CGUM9TC6.js";import"./config-C9m9eBw5.js";import"./logger-CC3afzWM.js";import{parseDate as n}from"./parse-date-D4osZfpm.js";import{getSubPath as r}from"./common-utils-CI-xkOWZ.js";import"./dist-0j_z2rfc.js";import"./helpers-nWIDkd0K.js";import{art as i}from"./render-DOz85fGU.js";import"./ofetch-ZUQ1sEMc.js";import{got_default as a}from"./got-CB83B8oA.js";import{timezone as o}from"./timezone-BrNu6iXe.js";import s from"node:path";import c from"dayjs";import{load as l}from"cheerio";t();const u=`https://www.dlsite.com`,d={show_type:1,show_layout:1,per_page:100},f=(e,t)=>c(e).format(t),p=(e,t)=>{let n=Object.keys(t),r=n.map(e=>`/${e}/${t[e]}`).join(``),i=e.replaceAll(RegExp(`(/${n.join(String.raw`/\w+|/`)}/\\w+)`,`g`),``);return`${i}${/=/.test(i)?``:`/=`}${r}`},m=e=>{let t=e.match(/(\d{4}).*(\d{2}).*(\d{2})/);return t?n(`${t[1]}-${t[2]}-${t[3]}`,`YYYY-MM-DD`):n(e.split(`:`).pop().trim(),`MMM/DD/YYYY`)},h=async e=>{let t=`${u}/home-touch/product/info/ajax?product_id=${e}`,n=await a({method:`get`,url:t});return n.data},g=async t=>{i.defaults.imports.formatDate=f;let g=r(t)===`/`?`/home/new`:r(t),_=t.req.query(`limit`)?Number.parseInt(t.req.query(`limit`)):100,v=`${u}${p(g,d)}`,y=await a({method:`get`,url:v}),b=l(y.data),x=b(`dt.work_name`).slice(0,_),S=b(`.work_update`).length===0?void 0:m(b(`.work_update`).text()),C=await h(x.toArray().map(e=>b(e).find(`a`).attr(`href`).match(/_id\/(.*?)\.html/)[1]).join(`,`)),w=x.toArray().map(t=>{t=b(t).parentsUntil(`tbody, ul`);let r=t.find(`.work_name a`),a=r.text(),l=r.attr(`href`),u=l.match(/_id\/(.*?)\.html/)[1],d=t.find(`.work_text`).text(),f=t.find(`.maker_name a`).toArray().map(e=>({name:b(e).text(),link:b(e).attr(`href`)})),p=t.find(`div[data-samples]`).length===0?[]:JSON.parse(t.find(`div[data-samples]`).attr(`data-samples`).replaceAll(`'`,`"`)).map(e=>e.thumb),m=t.find(`.work_category`).find(`a`).toArray().map(e=>({text:b(e).text(),link:b(e).attr(`href`)})),h=t.find(`.work_genre`).find(`span[title]`).toArray().map(e=>({text:b(e).text()})),g=t.find(`.search_tag`).find(`a`).toArray().map(e=>({text:b(e).text(),link:b(e).attr(`href`)})),_=t.find(`.icon_wrap`).find(`span[title]`).toArray().map(e=>({text:b(e).text()})),v=C[u],y=o(n(v.regist_date),9),x=v.discount_rate,w=v.discount_end_date?o(n(v.discount_end_date,`MM/DD HH:mm`),9):void 0;return p=p.length===0?[v.work_image]:p,{title:`${x?`${x}% OFF
                        ${` ${w?`${c(w).format(`YYYY-MM-DD HH:mm`)} まで`:``}`}`:` `}${a}`,link:l,pubDate:y,author:f.map(e=>e.name).join(` / `),category:[...m.map(e=>e.text),...h.map(e=>e.text),...g.map(e=>e.text),..._.map(e=>e.text)],guid:`dlsite-${u}`,description:i(s.join(e,`templates/description-3ff6e827.art`),{detail:v,images:p,authors:f,discountRate:x,discountEndDate:w,updatedDate:S,pubDate:y,workCategories:m,workGenres:h,searchTags:g,description:d})}});return{title:b(`title`).text(),description:b(`meta[name="description"]`).attr(`content`),link:v,item:w,allowEmpty:!0}},_={path:`*`,name:`Unknown`,maintainers:[],handler:v};async function v(e){return await g(e)}export{_ as route};