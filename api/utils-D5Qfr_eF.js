import{config as e}from"./config-DYqAlsU3.js";import{logger_default as t}from"./logger-BlLSmUdl.js";import{proxy_default as n}from"./proxy-kot7LoOQ.js";import{ofetch_default as r}from"./ofetch-CDAeBYLA.js";import{cache_default as i}from"./cache-7MGQxbL-.js";import{parseDate as a}from"./parse-date-B2cCVoGk.js";import{got_default as o}from"./got-Cw4D6IS5.js";import{invalid_parameter_default as s}from"./invalid-parameter-0LlYSQjk.js";import{fallback as c,queryToBoolean as l,queryToInteger as u}from"./readable-social-Dld9apEb.js";import{puppeteer_default as d}from"./puppeteer-BJ-mUzln.js";import{config_not_found_default as f}from"./config-not-found-DTjmIGAO.js";import{ProxyAgent as p}from"undici";import{RateLimiterMemory as m,RateLimiterQueue as h,RateLimiterRedis as g}from"rate-limiter-flexible";import _ from"url";import v from"crypto";import y from"crypto-js";import b from"query-string";import ee from"oauth-1.0a";import{v5 as x}from"uuid";import{authenticator as S}from"otplib";import{Cookie as C,CookieJar as w}from"tough-cookie";import{CookieAgent as T,CookieClient as E}from"http-cookie-agent/undici";import{TwitterApi as D}from"twitter-api-v2";const O=`https://api.x.com`,te=`3nVuSoBZnx6U4vzUxf5w`,ne=`Bcs59EFbbsdF6Sl9Ng71smgStWEGwXXKSjYvPVt7qys`,re=[`/graphql/u7wQyGi6oExe8_TRWGMq4Q/UserResultByScreenNameQuery`,`/graphql/oPppcargziU1uDQHAUmH-A/UserResultByIdQuery`,`/graphql/3JNH4e9dq1BifLxAa3UMWg/UserWithProfileTweetsQueryV2`,`/graphql/8IS8MaO-2EN6GZZZb8jF0g/UserWithProfileTweetsAndRepliesQueryV2`,`/graphql/PDfFf8hGeJvUCiTyWtw4wQ/MediaTimelineV2`,`/graphql/q94uRCEn65LZThakYcPT6g/TweetDetail`,`/graphql/sITyJdhRPpvpEjg4waUmTA/TweetResultByIdQuery`,`/graphql/gkjsKepM6gl_HmFWoWKfgg/SearchTimeline`,`/graphql/iTpgCtbdxrsJfyx0cFjHqg/ListByRestId`,`/graphql/-kmqNvm5Y-cVrfvBy6docg/ListBySlug`,`/graphql/P4NpVZDqUD_7MEM84L-8nw/ListMembers`,`/graphql/BbGLL1ZfMibdFNWlk7a0Pw/ListTimeline`],k=Object.fromEntries(re.map(e=>[e.split(`/`)[3].replace(/V2$|Query$|QueryV2$/,``),e])),A=JSON.stringify({android_graphql_skip_api_media_color_palette:!1,blue_business_profile_image_shape_enabled:!1,creator_subscriptions_subscription_count_enabled:!1,creator_subscriptions_tweet_preview_api_enabled:!0,freedom_of_speech_not_reach_fetch_enabled:!1,graphql_is_translatable_rweb_tweet_is_translatable_enabled:!1,hidden_profile_likes_enabled:!1,highlights_tweets_tab_ui_enabled:!1,interactive_text_enabled:!1,longform_notetweets_consumption_enabled:!0,longform_notetweets_inline_media_enabled:!1,longform_notetweets_richtext_consumption_enabled:!0,longform_notetweets_rich_text_read_enabled:!1,responsive_web_edit_tweet_api_enabled:!1,responsive_web_enhance_cards_enabled:!1,responsive_web_graphql_exclude_directive_enabled:!0,responsive_web_graphql_skip_user_profile_image_extensions_enabled:!1,responsive_web_graphql_timeline_navigation_enabled:!1,responsive_web_media_download_video_enabled:!1,responsive_web_text_conversations_enabled:!1,responsive_web_twitter_article_tweet_consumption_enabled:!1,responsive_web_twitter_blue_verified_badge_is_enabled:!0,rweb_lists_timeline_redesign_enabled:!0,spaces_2022_h2_clipping:!0,spaces_2022_h2_spaces_communities:!0,standardized_nudges_misinfo:!1,subscriptions_verification_info_enabled:!0,subscriptions_verification_info_reason_enabled:!0,subscriptions_verification_info_verified_since_enabled:!0,super_follow_badge_privacy_enabled:!1,super_follow_exclusive_tweet_notifications_enabled:!1,super_follow_tweet_api_enabled:!1,super_follow_user_api_enabled:!1,tweet_awards_web_tipping_enabled:!1,tweet_with_visibility_results_prefer_gql_limited_actions_policy_enabled:!1,tweetypie_unmention_optimization_enabled:!1,unified_cards_ad_metadata_container_dynamic_card_content_query_enabled:!1,verified_phone_label_enabled:!1,vibe_api_enabled:!1,view_counts_everywhere_api_enabled:!1}),j=`Bearer AAAAAAAAAAAAAAAAAAAAAFXzAwAAAAAAMHCxpeSDG1gLNLghVe8d74hl6k4%3DRUMF4xAQLsbeBhTSRrCiQpJtxoGWeyHrDb5te2jpGskWDFW82F`,ie=O+`/1.1/guest/activate.json`,M=`https://api.x.com/1.1/onboarding/task.json`,ae=`d41d092b-b007-48f7-9129-e9538d2d8fe9`,N={"User-Agent":`TwitterAndroid/10.21.0-release.0 (310210000-r-0) ONEPLUS+A3010/9 (OnePlus;ONEPLUS+A3010;OnePlus;OnePlus3;0;;1;2016)`,"X-Twitter-API-Version":`5`,"X-Twitter-Client":`TwitterAndroid`,"X-Twitter-Client-Version":`10.21.0-release.0`,"OS-Version":`28`,"System-User-Agent":`Dalvik/2.1.0 (Linux; U; Android 9; ONEPLUS A3010 Build/PKQ1.181203.001)`,"X-Twitter-Active-User":`yes`,"Content-Type":`application/json`,Authorization:j},oe=i.clients.redisClient?new g({points:1,duration:20,execEvenly:!0,storeClient:i.clients.redisClient}):new m({points:1,duration:20,execEvenly:!0}),se=new h(oe),P=async(e,t,n)=>await o.post(M,{headers:N,json:{flow_token:e,subtask_inputs:[Object.assign({subtask_id:t},n)]}}),ce={async LoginEnterUserIdentifier({flowToken:e,username:t}){return await P(e,`LoginEnterUserIdentifier`,{enter_text:{suggestion_id:null,text:t,link:`next_link`}})},async LoginEnterPassword({flowToken:e,password:t}){return await P(e,`LoginEnterPassword`,{enter_password:{password:t,link:`next_link`}})},async LoginEnterAlternateIdentifierSubtask({flowToken:e,phoneOrEmail:t}){return await P(e,`LoginEnterAlternateIdentifierSubtask`,{enter_text:{suggestion_id:null,text:t,link:`next_link`}})},async AccountDuplicationCheck({flowToken:e}){return await P(e,`AccountDuplicationCheck`,{check_logged_in_account:{link:`AccountDuplicationCheck_false`}})},async LoginTwoFactorAuthChallenge({flowToken:e,authenticationSecret:t}){let n=S.generate(t);return await P(e,`LoginTwoFactorAuthChallenge`,{enter_text:{suggestion_id:null,text:n,link:`next_link`}})}};async function le({username:e,password:n,authenticationSecret:a,phoneOrEmail:s}){return await i.tryGet(`twitter:authentication:${e}`,async()=>{try{await se.removeTokens(1),t.debug(`Twitter login start.`),N[`X-Twitter-Client-DeviceID`]=x(e,ae);let i=v.randomUUID().replaceAll(`-`,``),c=await o(ie,{headers:{authorization:j,"x-csrf-token":i,cookie:`ct0=`+i},method:`POST`});t.debug(`Twitter login: guest token`),N[`x-guest-token`]=c.data.guest_token;let l=await r.raw(M+`?`+new URLSearchParams({flow_name:`login`,api_version:`1`,known_device_token:``,sim_country_code:`us`}).toString(),{method:`POST`,headers:N,body:{flow_token:null,input_flow_data:{country_code:null,flow_context:{referrer_context:{referral_details:`utm_source=google-play&utm_medium=organic`,referrer_url:``},start_location:{location:`deeplink`}},requested_variant:null,target_user_id:0}}}).then(({headers:e,_data:t})=>(N.att=e.get(`att`),{data:t}));t.debug(`Twitter login flow start.`);let u=async({data:r})=>{let{subtask_id:i,open_account:o}=r.subtasks.shift();if(o)return o;if(!(i in ce)){t.error(`Twitter login flow task failed: unknown subtask: ${i}`);return}return l=await ce[i]({flowToken:r.flow_token,username:e,password:n,authenticationSecret:a,phoneOrEmail:s}),t.debug(`Twitter login flow task finished: subtask: ${i}.`),await u(l)},d=await u(l);return t.debug(`Twitter login flow finished.`),d?t.debug(`Twitter login success.`,d):t.error(`Twitter login failed. ${JSON.stringify(l.data?.subtasks,null,2)}`),d}catch(n){t.error(`Twitter username ${e} login failed:`,n)}},60*60*24*30,!1)}var ue=le;let de=0;async function fe(){let t;if(e.twitter.username&&e.twitter.password){let n=de++%e.twitter.username.length,r=e.twitter.username[n],i=e.twitter.password[n],a=e.twitter.authenticationSecret?.[n],o=e.twitter.phoneOrEmail?.[n];if(r&&i){let e=await ue({username:r,password:i,authenticationSecret:a,phoneOrEmail:o});if(!e)throw new f(`Invalid twitter configs: ${r}`);t={key:e.oauth_token,secret:e.oauth_token_secret,cacheKey:`twitter:authentication:${r}`}}}else throw new f(`Invalid twitter configs`);return t}const F=async(e,t)=>{let n=await fe(),a=new ee({consumer:{key:te,secret:ne},signature_method:`HMAC-SHA1`,hash_function:(e,t)=>y.HmacSHA1(e,t).toString(y.enc.Base64)}),o={url:`${e}?${b.stringify(t)}`,method:`GET`,headers:{connection:`keep-alive`,"content-type":`application/json`,"x-twitter-active-user":`yes`,authority:`api.x.com`,"accept-encoding":`gzip`,"accept-language":`en-US,en;q=0.9`,accept:`*/*`,DNT:`1`}},s=await r.raw(o.url,{headers:a.toHeader(a.authorize(o,n))});return s.status===401&&i.globalCache.set(n.cacheKey,``),s._data},I=async(e,t,n,r)=>{let{data:i}=await F(O+e,{variables:JSON.stringify({...n,rest_id:t}),features:A}),a;if(r){a=i;for(let e of r)a=a[e];a=a.instructions}else a=i.user_result.result.timeline_response.timeline.instructions;return a.find(e=>e.__typename===`TimelineAddEntries`||e.type===`TimelineAddEntries`).entries},pe=(e,t={})=>I(k.UserWithProfileTweets,e,{...t,withQuickPromoteEligibilityTweetFields:!0}),me=(e,t={})=>I(k.UserWithProfileTweetsAndReplies,e,{...t,count:20}),he=(e,t={})=>I(k.MediaTimeline,e,t),ge=(e,t={})=>I(k.SearchTimeline,null,{...t,rawQuery:e,count:20,product:`Latest`,withDownvotePerspective:!1,withReactionsMetadata:!1,withReactionsPerspective:!1},[`search_by_raw_query`,`search_timeline`,`timeline`]),_e=(e,t)=>I(k.TweetDetail,e,{...t,includeHasBirdwatchNotes:!1,includePromotedContent:!1,withBirdwatchNotes:!1,withVoice:!1,withV2Timeline:!0},[`threaded_conversation_with_injections_v2`]),ve=(e,t={})=>I(k.ListTimeline,e,{...t},[`list`,`timeline_response`,`timeline`]);function L(e,t,n){let r=[],i=[];for(let n of e){let e=n.entryId;e&&(e.startsWith(`tweet-`)&&i.push(n),t&&t.some(t=>e.startsWith(t))&&i.push(...n.content.items))}for(let e of i)if(e.entryId){let t=e.content||e.item,i=t?.content?.tweetResult?.result||t?.itemContent?.tweet_results?.result;if(i&&i.tweet&&(i=i.tweet),i){let e=i.legacy?.retweeted_status_result?.result;for(let t of[i,e]){if(!t?.legacy)continue;t.legacy.user=t.core?.user_result?.result?.legacy||t.core?.user_results?.result?.legacy,t.legacy.id_str=t.rest_id;let e=t.quoted_status_result?.result;if(e&&(t.legacy.quoted_status=e.legacy,t.legacy.quoted_status.user=e.core.user_result?.result?.legacy||e.core.user_results?.result?.legacy),t.note_tweet){let e=t.note_tweet.note_tweet_results.result;t.legacy.entities.hashtags=e.entity_set.hashtags,t.legacy.entities.symbols=e.entity_set.symbols,t.legacy.entities.urls=e.entity_set.urls,t.legacy.entities.user_mentions=e.entity_set.user_mentions,t.legacy.full_text=e.text}}let t=i.legacy;t&&(e&&(t.retweeted_status=e.legacy),(n===void 0||t.user_id_str===n+``)&&r.push(t))}}return r}const ye=async(e,t={})=>L(await pe(e,t)),be=async(e,t={})=>L(await me(e,t),[`profile-conversation-`],e),xe=async(e,t={})=>L(await he(e,t)),Se=async(e,t={})=>L(await _e(e,t),[`homeConversation-`,`conversationthread-`]),Ce=async(e,t={})=>L(await ve(e,t)),we=function(e){let t=[];for(let n of e){if(n.retweeted_status)continue;t.push(n)}return t},Te=e=>F(`${O}${k.UserResultByScreenName}`,{variables:`{"screen_name":"${e}","withHighlightedLabel":true}`,features:A}),Ee=e=>F(`${O}${k.UserByRestId}`,{variables:`{"userId":"${e}","withHighlightedLabel":true}`,features:A}),De=e=>e.startsWith(`+`)?Ee(e.slice(1)):Te(e),Oe=e=>i.tryGet(`twitter-userdata-${e}`,()=>De(e)),ke=async e=>{let t=await Oe(e);return(t.data?.user||t.data?.user_result)?.result?.rest_id},Ae=async e=>{let t=await Oe(e);return(t.data?.user||t.data?.user_result)?.result?.legacy},R=async(t,n,r)=>{let a=await ke(t);if(a===void 0)throw new s(`User not found`);let o=r.name,c=JSON.stringify(n);return i.tryGet(`twitter:${a}:${o}:${c}`,()=>r(a,n),e.cache.routeExpire,!1)},je=(e,t={})=>R(e,t,ye),Me=async(e,n={})=>{let r=[],a=await ke(e);await Promise.all([je,Ne,Pe].map(async i=>{try{r.push(...await i(e,n))}catch(n){t.warn(`Failed to get tweets for ${e} with ${i.name}: ${n}`)}}));let o=`twitter:user:tweets-cache:${a}`,s=await i.get(o);s&&(s=JSON.parse(s),s&&s.length&&(r=[...s,...r]));let c=new Set;return r=r.filter(e=>!e.in_reply_to_user_id_str||e.in_reply_to_user_id_str===a).map(e=>{let t=e.id_str||e.conversation_id_str;return!c.has(t)&&c.add(t)&&e}).filter(Boolean).sort((e,t)=>(t.id_str||t.conversation_id_str)-(e.id_str||e.conversation_id_str)).slice(0,20),i.set(o,JSON.stringify(r)),r},Ne=(e,t={})=>R(e,t,be),Pe=(e,t={})=>R(e,t,xe),Fe=(e,t)=>R(e,t,Se),Ie=async(e,t={})=>L(await ge(e,t)),Le=(t,n={})=>i.tryGet(`twitter:${t}:getListById:${JSON.stringify(n)}`,()=>Ce(t,n),e.cache.routeExpire,!1);var Re={getUser:Ae,getUserTweets:Me,getUserTweetsAndReplies:Ne,getUserMedia:Pe,excludeRetweet:we,getSearch:Ie,getList:Le,getUserTweet:Fe,init:()=>void 0};const ze=`https://x.com/i/api`,Be=[`/graphql/E3opETHurmVJflFsUBVuUQ/UserTweets`,`/graphql/Yka-W8dz7RaEuQNkroPkYw/UserByScreenName`,`/graphql/HJFjzBgCs16TqxewQOeLNg/HomeTimeline`,`/graphql/DiTkXJgLqBBxCs7zaYsbtA/HomeLatestTimeline`,`/graphql/bt4TKuFz4T7Ckk-VvQVSow/UserTweetsAndReplies`,`/graphql/dexO_2tohK86JDudXXG3Yw/UserMedia`,`/graphql/Qw77dDjp9xCpUY-AXwt-yQ/UserByRestId`,`/graphql/UN1i3zUiCWa-6r-Uaho4fw/SearchTimeline`,`/graphql/Pa45JvqZuKcW1plybfgBlQ/ListLatestTweetsTimeline`,`/graphql/QuBlQ6SxNAQCt6-kBiCXCQ/TweetDetail`],z=Object.fromEntries(Be.map(e=>[e.split(`/`)[3].replace(/V2$|Query$|QueryV2$/,``),e])),Ve=[`UserByScreenName`,`UserByRestId`,`UserTweets`,`UserTweetsAndReplies`,`ListLatestTweetsTimeline`,`SearchTimeline`],He={hidden_profile_subscriptions_enabled:!0,rweb_tipjar_consumption_enabled:!0,responsive_web_graphql_exclude_directive_enabled:!0,verified_phone_label_enabled:!1,subscriptions_verification_info_is_identity_verified_enabled:!0,subscriptions_verification_info_verified_since_enabled:!0,highlights_tweets_tab_ui_enabled:!0,responsive_web_twitter_article_notes_tab_enabled:!0,subscriptions_feature_can_gift_premium:!0,creator_subscriptions_tweet_preview_api_enabled:!0,responsive_web_graphql_skip_user_profile_image_extensions_enabled:!1,responsive_web_graphql_timeline_navigation_enabled:!0},B={rweb_tipjar_consumption_enabled:!0,responsive_web_graphql_exclude_directive_enabled:!0,verified_phone_label_enabled:!1,creator_subscriptions_tweet_preview_api_enabled:!0,responsive_web_graphql_timeline_navigation_enabled:!0,responsive_web_graphql_skip_user_profile_image_extensions_enabled:!1,communities_web_enable_tweet_community_results_fetch:!0,c9s_tweet_anatomy_moderator_badge_enabled:!0,articles_preview_enabled:!0,responsive_web_edit_tweet_api_enabled:!0,graphql_is_translatable_rweb_tweet_is_translatable_enabled:!0,view_counts_everywhere_api_enabled:!0,longform_notetweets_consumption_enabled:!0,responsive_web_twitter_article_tweet_consumption_enabled:!0,tweet_awards_web_tipping_enabled:!1,creator_subscriptions_quote_tweet_preview_enabled:!1,freedom_of_speech_not_reach_fetch_enabled:!0,standardized_nudges_misinfo:!0,tweet_with_visibility_results_prefer_gql_limited_actions_policy_enabled:!0,rweb_video_timestamps_enabled:!0,longform_notetweets_rich_text_read_enabled:!0,longform_notetweets_inline_media_enabled:!0,responsive_web_enhance_cards_enabled:!1},V={rweb_tipjar_consumption_enabled:!0,responsive_web_graphql_exclude_directive_enabled:!0,verified_phone_label_enabled:!1,creator_subscriptions_tweet_preview_api_enabled:!0,responsive_web_graphql_timeline_navigation_enabled:!0,responsive_web_graphql_skip_user_profile_image_extensions_enabled:!1,communities_web_enable_tweet_community_results_fetch:!0,c9s_tweet_anatomy_moderator_badge_enabled:!0,articles_preview_enabled:!0,responsive_web_edit_tweet_api_enabled:!0,graphql_is_translatable_rweb_tweet_is_translatable_enabled:!0,view_counts_everywhere_api_enabled:!0,longform_notetweets_consumption_enabled:!0,responsive_web_twitter_article_tweet_consumption_enabled:!0,tweet_awards_web_tipping_enabled:!1,creator_subscriptions_quote_tweet_preview_enabled:!1,freedom_of_speech_not_reach_fetch_enabled:!0,standardized_nudges_misinfo:!0,tweet_with_visibility_results_prefer_gql_limited_actions_policy_enabled:!0,rweb_video_timestamps_enabled:!0,longform_notetweets_rich_text_read_enabled:!0,longform_notetweets_inline_media_enabled:!0,responsive_web_enhance_cards_enabled:!1},H={UserByScreenName:He,UserByRestId:He,UserTweets:B,UserTweetsAndReplies:B,UserMedia:B,SearchTimeline:B,ListLatestTweetsTimeline:B,HomeTimeline:B,HomeLatestTimeline:V,TweetDetail:V,Likes:B},Ue=`Bearer AAAAAAAAAAAAAAAAAAAAANRILgAAAAAAnNwIzUejRCOuH5E6I8xnZz4puTs%3D1Zv7ttfk8LF81IUq16cHjhLTvJu4FA33AGWWjCpTnA`,We=i.clients.redisClient?new g({points:1,duration:20,execEvenly:!0,storeClient:i.clients.redisClient}):new m({points:1,duration:20,execEvenly:!0}),Ge=new h(We);async function Ke({username:e,password:n,authenticationSecret:r}){if(!(!e||!n))try{await Ge.removeTokens(1);let i=new w,a=await d({stealth:!0}),o=await a.newPage();await o.goto(`https://x.com/i/flow/login`),await o.waitForSelector(`input[autocomplete="username"]`),await o.type(`input[autocomplete="username"]`,e);let s=await o.$$(`button`);if(await s[3]?.click(),await o.waitForSelector(`input[autocomplete="current-password"]`),await o.type(`input[autocomplete="current-password"]`,n),(await o.waitForSelector(`button[data-testid="LoginForm_Login_Button"]`))?.click(),r){await o.waitForSelector(`input[inputmode="numeric"]`);let e=S.generate(r);await o.type(`input[inputmode="numeric"]`,e),(await o.waitForSelector(`button[data-testid="ocfEnterTextNextButton"]`))?.click()}let c=new Promise(n=>{o.on(`response`,async r=>{if(r.url().includes(`/HomeTimeline`)){let a=await r.json(),s=a?.data?.home?.home_timeline_urt?.instructions?.[0]?.entries?.[0]?.entryId;s===`messageprompt-suspended-prompt`&&(t.error(`twitter debug: twitter username ${e} login failed: messageprompt-suspended-prompt`),n(``));let c=await o.cookies();for(let e of c)i.setCookieSync(`${e.name}=${e.value}`,`https://x.com`);t.debug(`twitter debug: twitter username ${e} login success`),n(JSON.stringify(i.serializeSync()))}})}),l=await c;return await a.close(),l}catch(n){t.error(`twitter debug: twitter username ${e} login failed:`,n)}}var U=Ke;let qe=0;const Je=async e=>{let t=await i.get(`twitter:cookie:${e}`);if(t)return t;let a=new w;await a.setCookie(`auth_token=${e}`,`https://x.com`);try{let t=n.proxyUri?new p({factory:(e,t)=>new E(e,{...t,cookies:{jar:a}}),uri:n.proxyUri}):new T({cookies:{jar:a}});if(e)await r(`https://x.com`,{dispatcher:t});else{let e=await r(`https://x.com/narendramodi?mx=2`,{dispatcher:t}),n=e.match(/document\.cookie="gt=(\d+)/)?.[1];n&&a.setCookieSync(`gt=${n}`,`https://x.com`)}let o=JSON.stringify(a.serializeSync());return i.set(`twitter:cookie:${e}`,o),o}catch{return``}},W=`twitter:lock-token1:`,G=async n=>{if(e.twitter.authToken&&n>0){let r=qe++%e.twitter.authToken.length,a=e.twitter.authToken[r],o=await i.get(`${W}${a}`,!1);return o?(t.debug(`twitter debug: twitter cookie for token ${a} is locked, retry: ${n}`),await new Promise(e=>setTimeout(e,Math.random()*500+500)),await G(n-1)):(t.debug(`twitter debug: lock twitter cookie for token ${a}`),await i.set(`${W}${a}`,`1`,20),{token:a,username:e.twitter.username?.[r],password:e.twitter.password?.[r],authenticationSecret:e.twitter.authenticationSecret?.[r]})}},K=async(a,o,s)=>{let c=await G(30);if(!c&&!s?.allowNoAuth)throw new f(`No valid Twitter token found`);let l=`${a}?${b.stringify(o)}`,u=await Je(c?.token);!u&&c&&(u=await U({username:c.username,password:c.password,authenticationSecret:c.authenticationSecret}));let d;if(u){t.debug(`twitter debug: got twitter cookie for token ${c?.token}`),typeof u==`string`&&(u=JSON.parse(u));let e=w.deserializeSync(u),r=n.proxyUri?new p({factory:(t,n)=>new E(t,{...n,cookies:{jar:e}}),uri:n.proxyUri}):new T({cookies:{jar:e}});n.proxyUri&&t.debug(`twitter debug: Proxying request: ${l}`),d={jar:e,agent:r}}else if(c)throw new f(`Twitter cookie for token ${c?.token?.replace(/(\w{8})(\w+)/,(e,t,n)=>t+`*`.repeat(n.length))} is not valid`);let m=d?Object.fromEntries(d.jar.getCookieStringSync(a).split(`;`).map(e=>C.parse(e)?.toJSON()).map(e=>[e?.key,e?.value])):{},h=await r.raw(l,{retry:0,headers:{authority:`x.com`,accept:`*/*`,"accept-language":`en-US,en;q=0.9`,authorization:Ue,"cache-control":`no-cache`,"content-type":`application/json`,dnt:`1`,pragma:`no-cache`,referer:`https://x.com/`,"x-twitter-active-user":`yes`,"x-twitter-client-language":`en`,"x-csrf-token":m.ct0,...c?.token?{"x-twitter-auth-type":`OAuth2Session`}:{"x-guest-token":m.gt}},dispatcher:d?.agent,onResponse:async({response:n})=>{let r=n.headers.get(`x-rate-limit-remaining`),a=Number.parseInt(r||`0`),o=n.headers.get(`x-rate-limit-reset`);if(t.debug(`twitter debug: twitter rate limit remaining for token ${c?.token} is ${r} and reset at ${o}, auth: ${JSON.stringify(c)}, status: ${n.status}, data: ${JSON.stringify(n._data?.data)}, cookie: ${JSON.stringify(d?.jar.serializeSync())}`),c)if(r&&a<2&&o){let e=new Date(Number.parseInt(o)*1e3),r=(e.getTime()-Date.now())/1e3;t.debug(`twitter debug: twitter rate limit exceeded for token ${c.token} with status ${n.status}, will unlock after ${r}s`),await i.set(`${W}${c.token}`,`1`,Math.ceil(r)*2)}else if(n.status===429||JSON.stringify(n._data?.data)===`{"user":{}}`)t.debug(`twitter debug: twitter rate limit exceeded for token ${c.token} with status ${n.status}`),await i.set(`${W}${c.token}`,`1`,2e3);else if(n.status===403||n.status===401){let r=await U({username:c.username,password:c.password,authenticationSecret:c.authenticationSecret});if(r)t.debug(`twitter debug: reset twitter cookie for token ${c.token}, ${r}`),await i.set(`twitter:cookie:${c.token}`,r,e.cache.contentExpire),t.debug(`twitter debug: unlock twitter cookie for token ${c.token} with error1`),await i.set(`${W}${c.token}`,``,1);else{let r=e.twitter.authToken?.indexOf(c.token);if(r!==void 0&&r!==-1&&e.twitter.authToken?.splice(r,1),c.username){let t=e.twitter.username?.indexOf(c.username);t!==void 0&&t!==-1&&e.twitter.username?.splice(t,1)}if(c.password){let t=e.twitter.password?.indexOf(c.password);t!==void 0&&t!==-1&&e.twitter.password?.splice(t,1)}t.debug(`twitter debug: delete twitter cookie for token ${c.token} with status ${n.status}, remaining tokens: ${e.twitter.authToken?.length}`),await i.set(`${W}${c.token}`,`1`,86400)}}else t.debug(`twitter debug: unlock twitter cookie with success for token ${c.token}`),await i.set(`${W}${c.token}`,``,1)}});return c?.token&&(t.debug(`twitter debug: update twitter cookie for token ${c.token}`),await i.set(`twitter:cookie:${c.token}`,JSON.stringify(d?.jar.serializeSync()),e.cache.contentExpire)),h._data},q=async(n,i,a,o)=>{let s={variables:JSON.stringify({...a,userId:i}),features:JSON.stringify(H[n])},c=async()=>{if(e.twitter.thirdPartyApi&&Ve.includes(n)){let{data:t}=await r(`${e.twitter.thirdPartyApi}${z[n]}`,{method:`GET`,params:s});return t}let{data:t}=await K(ze+z[n],s);return t},l=e=>{if(o){let t=e;for(let e of o)t=t[e];return t.instructions}let n=e?.user?.result?.timeline_v2?.timeline?.instructions;return n||t.debug(`twitter debug: instructions not found in data: ${JSON.stringify(e)}`),n},u=await c(),d=l(u);if(!d)return[];let f=d.find(e=>e.type===`TimelineAddToModule`)?.moduleItems,p=d.find(e=>e.type===`TimelineAddEntries`)?.entries;return f||p||[]};function J(e,t,n){let r=[],i=[];for(let n of e){let e=n.entryId;e&&((e.startsWith(`tweet-`)||e.startsWith(`profile-grid-0-tweet-`))&&i.push(n),t&&t.some(t=>e.startsWith(t))&&i.push(...n.content.items))}for(let e of i)if(e.entryId){let t=e.content||e.item,i=t?.content?.tweetResult?.result||t?.itemContent?.tweet_results?.result;if(i&&i.tweet&&(i=i.tweet),i){let e=i.legacy?.retweeted_status_result?.result;for(let t of[i,e]){if(!t?.legacy)continue;t.legacy.user=t.core?.user_result?.result?.legacy||t.core?.user_results?.result?.legacy,t.legacy.id_str=t.rest_id;let e=t.quoted_status_result?.result?.tweet||t.quoted_status_result?.result;if(e&&(t.legacy.quoted_status=e.legacy,t.legacy.quoted_status.user=e.core.user_result?.result?.legacy||e.core.user_results?.result?.legacy),t.note_tweet){let e=t.note_tweet.note_tweet_results.result;t.legacy.entities.hashtags=e.entity_set.hashtags,t.legacy.entities.symbols=e.entity_set.symbols,t.legacy.entities.urls=e.entity_set.urls,t.legacy.entities.user_mentions=e.entity_set.user_mentions,t.legacy.full_text=e.text}}let t=i.legacy;t&&(e&&(t.retweeted_status=e.legacy),(n===void 0||t.user_id_str===n+``)&&r.push(t))}}return r}const Ye=t=>i.tryGet(`twitter-userdata-${t}`,()=>{let n={variables:t.startsWith(`+`)?JSON.stringify({userId:t.slice(1),withSafetyModeUserFields:!0}):JSON.stringify({screen_name:t,withSafetyModeUserFields:!0}),features:JSON.stringify(t.startsWith(`+`)?H.UserByRestId:H.UserByScreenName),fieldToggles:JSON.stringify({withAuxiliaryUserLabels:!1})};if(e.twitter.thirdPartyApi){let i=t.startsWith(`+`)?z.UserByRestId:z.UserByScreenName;return r(`${e.twitter.thirdPartyApi}${i}`,{method:`GET`,params:n})}return K(`${ze}${t.startsWith(`+`)?z.UserByRestId:z.UserByScreenName}`,n,{allowNoAuth:!t.startsWith(`+`)})}),Y=async(t,n,r)=>{let a=await Ye(t),o=(a.data?.user||a.data?.user_result)?.result?.rest_id;if(o===void 0)throw i.set(`twitter-userdata-${t}`,``,e.cache.contentExpire),new s(`User not found`);let c=r.name,l=JSON.stringify(n);return i.tryGet(`twitter:${o}:${c}:${l}`,()=>r(o,n),e.cache.routeExpire,!1)},Xe=(e,t)=>Y(e,t,async(e,t={})=>J(await q(`UserTweets`,e,{...t,count:20,includePromotedContent:!0,withQuickPromoteEligibilityTweetFields:!0,withVoice:!0,withV2Timeline:!0}))),Ze=(e,t)=>Y(e,t,async(e,t={})=>J(await q(`UserTweetsAndReplies`,e,{...t,count:20,includePromotedContent:!0,withCommunity:!0,withVoice:!0,withV2Timeline:!0}),[`profile-conversation-`],e)),Qe=(e,t)=>Y(e,t,async(e,t={})=>{let n=await q(`UserMedia`,e,{...t,count:20,includePromotedContent:!1,withClientEventToken:!1,withBirdwatchNotes:!1,withVoice:!0,withV2Timeline:!0}),r=n.find(e=>e.content?.cursorType===`Top`).content.value;return J(await q(`UserMedia`,e,{...t,cursor:r,count:20,includePromotedContent:!1,withClientEventToken:!1,withBirdwatchNotes:!1,withVoice:!0,withV2Timeline:!0}))}),$e=(e,t)=>Y(e,t,async(e,t={})=>J(await q(`Likes`,e,{...t,includeHasBirdwatchNotes:!1,includePromotedContent:!1,withBirdwatchNotes:!1,withVoice:!1,withV2Timeline:!0}))),et=(e,t)=>Y(e,t,async(e,t={})=>J(await q(`TweetDetail`,e,{...t,includeHasBirdwatchNotes:!1,includePromotedContent:!1,withBirdwatchNotes:!1,withVoice:!1,withV2Timeline:!0},[`threaded_conversation_with_injections_v2`]),[`homeConversation-`,`conversationthread-`])),tt=async(e,t)=>J(await q(`SearchTimeline`,void 0,{...t,rawQuery:e,count:20,querySource:`typed_query`,product:`Latest`},[`search_by_raw_query`,`search_timeline`,`timeline`])),nt=async(e,t)=>J(await q(`ListLatestTweetsTimeline`,void 0,{...t,listId:e,count:20},[`list`,`tweets_timeline`,`timeline`])),rt=async e=>{let t=await Ye(e);return(t.data?.user||t.data?.user_result)?.result?.legacy},it=async(e,t)=>J(await q(`HomeTimeline`,void 0,{...t,count:20,includePromotedContent:!0,latestControlAvailable:!0,requestContext:`launch`,withCommunity:!0},[`home`,`home_timeline_urt`])),at=async(e,t)=>J(await q(`HomeLatestTimeline`,void 0,{...t,count:20,includePromotedContent:!0,latestControlAvailable:!0,requestContext:`launch`,withCommunity:!0},[`home`,`home_timeline_urt`]));var ot={getUser:rt,getUserTweets:Xe,getUserTweetsAndReplies:Ze,getUserMedia:Qe,getUserLikes:$e,getUserTweet:et,getSearch:tt,getList:nt,getHomeTimeline:it,getHomeLatestTimeline:at,init:()=>{}};const st=e.twitter.thirdPartyApi,ct=e.twitter.username&&e.twitter.password,lt=e.twitter.authToken;let X={init:()=>{throw new f(`Twitter API is not configured`)},getUser:()=>null,getUserTweets:()=>null,getUserTweetsAndReplies:()=>null,getUserMedia:()=>null,getUserLikes:()=>null,getUserTweet:()=>null,getSearch:()=>null,getList:()=>null,getHomeTimeline:()=>null,getHomeLatestTimeline:()=>null};st||lt?X=ot:ct&&(X=Re);var ut=X;const dt=e=>_.parse(e,!0).query,Z=e=>{let t=null;if(t=e.match(/^(https?:\/\/\w+\.twimg\.com\/media\/[^/:]+)\.(jpg|jpeg|gif|png|bmp|webp)(:\w+)?$/i)){let e=t[2];return t[2]===`jpeg`&&(e=`jpg`),`${t[1]}?format=${e}&name=orig`}else if(t=e.match(/^(https?:\/\/\w+\.twimg\.com\/.+)(\?.+)$/i)){let n=dt(e);return!n.format||!n.name||n.name===`orig`?e:t[1]+`?format=`+n.format+`&name=orig`}else return e},ft=e=>e.replaceAll(/<br><br>|<br>/g,` `),Q=e=>{let t=e.full_text,n=e.id_str||e.conversation_id_str,r=e.entities.urls||[];for(let e of r)t=t.replaceAll(e.url,e.expanded_url?.endsWith(n)?``:e.expanded_url);let i=e.extended_entities?.media||[];for(let e of i)t=t.replaceAll(e.url,``);return t.trim().replaceAll(`
`,`<br>`)},pt=(e,{data:t=[]},n={})=>{let r=new URLSearchParams(e.req.param(`routeParams`)),i={readable:c(n.readable,l(r.get(`readable`)),!1),authorNameBold:c(n.authorNameBold,l(r.get(`authorNameBold`)),!1),showAuthorInTitle:c(n.showAuthorInTitle,l(r.get(`showAuthorInTitle`)),!1),showAuthorAsTitleOnly:c(n.showAuthorAsTitleOnly,l(r.get(`showAuthorAsTitleOnly`)),!1),showAuthorInDesc:c(n.showAuthorInDesc,l(r.get(`showAuthorInDesc`)),!1),showQuotedAuthorAvatarInDesc:c(n.showQuotedAuthorAvatarInDesc,l(r.get(`showQuotedAuthorAvatarInDesc`)),!1),showAuthorAvatarInDesc:c(n.showAuthorAvatarInDesc,l(r.get(`showAuthorAvatarInDesc`)),!1),showEmojiForRetweetAndReply:c(n.showEmojiForRetweetAndReply,l(r.get(`showEmojiForRetweetAndReply`)),!1),showSymbolForRetweetAndReply:c(n.showSymbolForRetweetAndReply,l(r.get(`showSymbolForRetweetAndReply`)),!0),showRetweetTextInTitle:c(n.showRetweetTextInTitle,l(r.get(`showRetweetTextInTitle`)),!0),addLinkForPics:c(n.addLinkForPics,l(r.get(`addLinkForPics`)),!1),showTimestampInDescription:c(n.showTimestampInDescription,l(r.get(`showTimestampInDescription`)),!1),showQuotedInTitle:c(n.showQuotedInTitle,l(r.get(`showQuotedInTitle`)),!1),widthOfPics:c(n.widthOfPics,u(r.get(`widthOfPics`)),-1),heightOfPics:c(n.heightOfPics,u(r.get(`heightOfPics`)),-1),sizeOfAuthorAvatar:c(n.sizeOfAuthorAvatar,u(r.get(`sizeOfAuthorAvatar`)),48),sizeOfQuotedAuthorAvatar:c(n.sizeOfQuotedAuthorAvatar,u(r.get(`sizeOfQuotedAuthorAvatar`)),24)};n=i;let{readable:o,authorNameBold:s,showAuthorInTitle:d,showAuthorAsTitleOnly:f,showAuthorInDesc:p,showQuotedAuthorAvatarInDesc:m,showAuthorAvatarInDesc:h,showEmojiForRetweetAndReply:g,showSymbolForRetweetAndReply:_,showRetweetTextInTitle:v,addLinkForPics:y,showTimestampInDescription:b,showQuotedInTitle:ee,widthOfPics:x,heightOfPics:S,sizeOfAuthorAvatar:C,sizeOfQuotedAuthorAvatar:w}=n,T=(e,t=``)=>{let n=``,r=e.video_info.variants.reduce((e,t)=>((t.bitrate||0)>(e.bitrate||-1/0)&&(e=t),e),{});if(r.url){let i=e.type===`animated_gif`?`autoplay loop muted webkit-playsinline playsinline`:``;o||(n+=`<br>`),n+=`<video width="${e.sizes.large.w}" height="${e.sizes.large.h}" src='${r.url}' ${i} controls='controls' poster='${Z(e.media_url_https)}' ${t}></video>`}return n},E=e=>{let t=``;if(e.extended_entities)for(let n of e.extended_entities.media){let e=``,r=``,i;switch(n.type){case`animated_gif`:case`video`:e=T(n);break;case`photo`:default:i=Z(n.media_url_https),o||(e+=`<br>`),y&&(e+=`<a href='${i}' target='_blank' rel='noopener noreferrer'>`),e+=`<img `,x>=0&&(e+=` width="${x}"`,r+=`width: ${x}px;`),S>0&&(e+=`height="${S}" `,r+=`height: ${S}px;`),x<=0&&S<=0&&(e+=`width="${n.sizes.large.w}" height="${n.sizes.large.h}" `),e+=` style="${r}" ${o?`hspace="4" vspace="8"`:``} src="${i}">`,y&&(e+=`</a>`);break}t+=e}return o&&t&&(t=`<br clear='both' /><div style='clear: both'></div>`+t),t},D=e=>{let t=``;if(e.extended_entities)for(let n of e.extended_entities.media){let e,r;switch(n.type){case`video`:e=T(n,`width="0" height="0"`);break;case`photo`:default:r=Z(n.media_url_https),e=`<img width='0' height='0' hidden='true' src='${r}'>`;break}t+=e}return t};return t.map(e=>{let t=e;e=e.retweeted_status||e,e.full_text=e.full_text||e.text,e.full_text=Q(e);let n=E(e),r=D(e),i=``,c=``;if(e.is_quote_status){let t=e.quoted_status;if(t){t.full_text=t.full_text||t.text;let e=t.user;i+=`<div class="rsshub-quote">`,o?(i+=`<br clear='both' /><div style='clear: both'></div>`,i+=`<blockquote style='background: #80808010;border-top:1px solid #80808030;border-bottom:1px solid #80808030;margin:0;padding:5px 20px;'>`):i+=`<br><br>`,o&&(i+=`<a href='https://x.com/${e.screen_name}' target='_blank' rel='noopener noreferrer'>`),m&&(i+=`<img width='${w}' height='${w}' src='${e.profile_image_url_https}' ${o?`hspace="8" vspace="8" align="left"`:``}>`),s&&(i+=`<strong>`),i+=e.name,s&&(i+=`</strong>`),o&&(i+=`</a>`),i+=`:&ensp;`,i+=Q(t),o||(i+=`<br>`),i+=E(t),r+=D(t),c+=g?` 💬 `:_?` RT `:``,c+=`${e.name}: ${Q(t)}`,o&&(i+=`<br><small>Link: <a href='https://x.com/${e.screen_name}/status/${t.id_str||t.conversation_id_str}' target='_blank' rel='noopener noreferrer'>https://x.com/${e.screen_name}/status/${t.id_str||t.conversation_id_str}</a></small>`),b&&(i+=`<br><small>`+a(t.created_at),i+=`</small>`,o&&(i+=`<br clear='both' /><div style='clear: both'></div>`)),o&&(i+=`</blockquote>`),i+=`</div>`}}let l=``;d&&(l+=t.user.name+`: `);let u=t!==e,y=e.is_quote_status;!u&&(!y||v)&&(e.in_reply_to_screen_name&&(l+=g?`↩️ `:_?`Re `:``),l+=ft(t.full_text)),u&&(l+=g?`🔁 `:_?`RT `:``,l+=e.user.name+`: `,e.in_reply_to_screen_name&&(l+=g?` ↩️ `:_?` Re `:``),l+=ft(e.full_text)),ee&&(l+=c),f&&(l=t.user.name);let x=``;p&&h&&(x+=r),u&&(p&&(o&&(x+=`<small>`,x+=`<a href='https://x.com/${t.user.screen_name}' target='_blank' rel='noopener noreferrer'>`),s&&(x+=`<strong>`),x+=t.user.name,s&&(x+=`</strong>`),o&&(x+=`</a>`),x+=`&ensp;`),x+=g?`🔁`:_?`RT`:``,p||(x+=`&ensp;`,o&&(x+=`<a href='https://x.com/${e.user.screen_name}' target='_blank' rel='noopener noreferrer'>`),s&&(x+=`<strong>`),x+=e.user.name,s&&(x+=`</strong>`),o&&(x+=`</a>`)),o&&(x+=`</small>`),x+=`<br>`),p&&(o&&(x+=`<a href='https://x.com/${e.user.screen_name}' target='_blank' rel='noopener noreferrer'>`),h&&(x+=`<img width='${C}' height='${C}' src='${e.user.profile_image_url_https}' ${o?`hspace="8" vspace="8" align="left"`:``}>`),s&&(x+=`<strong>`),x+=e.user.name,s&&(x+=`</strong>`),o&&(x+=`</a>`),x+=`:&ensp;`),e.in_reply_to_screen_name&&(x+=g?`↩️ `:_?`Re `:``),x+=e.full_text;let S=x.match(/(\s)?(#[^\s;<]+)/g)?.map(e=>e?.match(/#([^\s<]+)/)?.[1]);x+=n,x+=i,o&&(x+=`<br clear='both' /><div style='clear: both'></div>`),b&&(o&&(x+=`<hr>`),x+=`<small>${a(e.created_at)}</small>`);let T=t.user.screen_name&&(t.id_str||t.conversation_id_str)?`https://x.com/${t.user.screen_name}/status/${t.id_str||t.conversation_id_str}`:`https://x.com/${e.user.screen_name}/status/${e.id_str||e.conversation_id_str}`;return{title:l,author:[{name:t.user.name,url:`https://x.com/${t.user.screen_name}`,avatar:t.user.profile_image_url_https}],description:x,pubDate:a(e.created_at),link:T,guid:T.replace(`x.com`,`twitter.com`),category:S,_extra:u&&{links:[{url:`https://x.com/${e.user?.screen_name}/status/${e.conversation_id_str}`,type:`repost`}]}||e.is_quote_status&&{links:[{url:`https://x.com/${e.quoted_status?.user?.screen_name}/status/${e.quoted_status?.id_str||e.quoted_status?.conversation_id_str}`,type:`quote`}]}||e.in_reply_to_screen_name&&e.in_reply_to_status_id_str&&{links:[{url:`https://x.com/${e.in_reply_to_screen_name}/status/${e.in_reply_to_status_id_str}`,type:`reply`}]}}})};let $=()=>null;if(e.twitter.consumer_key&&e.twitter.consumer_secret){let t=e.twitter.consumer_key.split(`,`),n=e.twitter.consumer_secret.split(`,`),r={},i=0,a=-1;for(let[e,a]of t.entries()){let t=n[e];a&&t&&(r[e]=new D({appKey:a,appSecret:t}).readOnly,i=e+1)}$=()=>(a++,r[a%i].appLogin())}const mt=e=>{let t,n,r,i,a=!1;switch(e){case`exclude_rts_replies`:case`exclude_replies_rts`:n=!1,r=!1;break;case`include_replies`:n=!0,r=!0;break;case`exclude_rts`:n=!1,r=!1;break;default:{let o=new URLSearchParams(e);t=c(void 0,u(o.get(`count`))),n=c(void 0,l(o.get(`includeReplies`)),!1),r=c(void 0,l(o.get(`includeRts`)),!0),a=c(void 0,l(o.get(`forceWebApi`)),!1),i=c(void 0,l(o.get(`onlyMedia`)),!1)}}return{count:t,include_replies:n,include_rts:r,force_web_api:a,only_media:i}},ht=function(e){let t=[];for(let n of e){if(n.retweeted_status)continue;t.push(n)}return t},gt=function(e){let t=e.filter(e=>e.extended_entities&&e.extended_entities.media);return t};var _t={ProcessFeed:pt,getAppClient:$,parseRouteParams:mt,excludeRetweet:ht,keepOnlyMedia:gt};export{ut as api_default,_t as utils_default$8};