import"./esm-shims-CtP6w_ML.js";import"./config-DYqAlsU3.js";import"./logger-BlLSmUdl.js";import"./proxy-kot7LoOQ.js";import"./ofetch-CWQqZcqz.js";import"./helpers-RrXnNmv1.js";import{cache_default as e}from"./cache-CvppK6AM.js";import"./render-DE4LRFBD.js";import{parseDate as t}from"./parse-date-DHsdom8D.js";import"./md5-BJqXla8f.js";import{got_default as n}from"./got-BwctkUCD.js";import{ViewType as r}from"./types-Bi82qguM.js";import"./puppeteer-DQCLzTv0.js";import{fallback as i,queryToBoolean as a}from"./readable-social-CZfNaCIB.js";import{getLiveUrl as o,getVideoUrl as s,utils_default as c}from"./utils-CsTdEpjv.js";import{cache_default$1 as l}from"./cache-COOjRm1i.js";import u from"json-bigint";const d={path:`/user/dynamic/:uid/:routeParams?`,categories:[`social-media`,`popular`],view:r.SocialMedia,example:`/bilibili/user/dynamic/2267573`,parameters:{uid:`用户 id, 可在 UP 主主页中找到`,routeParams:`
| 键         | 含义                              | 接受的值       | 默认值 |
| ---------- | --------------------------------- | -------------- | ------ |
| showEmoji  | 显示或隐藏表情图片                | 0/1/true/false | false  |
| embed      | 默认开启内嵌视频                  | 0/1/true/false |  true  |
| useAvid    | 视频链接使用 AV 号 (默认为 BV 号) | 0/1/true/false | false  |
| directLink | 使用内容直链                      | 0/1/true/false | false  |
| hideGoods  | 隐藏带货动态                      | 0/1/true/false | false  |
| offset     | 偏移状态                         | string         | ""  |

用例：\`/bilibili/user/dynamic/2267573/showEmoji=1&embed=0&useAvid=1\``},features:{requireConfig:[{name:`BILIBILI_COOKIE_*`,optional:!0,description:"如果没有此配置，那么必须开启 puppeteer 支持；BILIBILI_COOKIE_{uid}: 用于用户关注动态系列路由，对应 uid 的 b 站用户登录后的 Cookie 值，`{uid}` 替换为 uid，如 `BILIBILI_COOKIE_2267573`，获取方式：\n1.  打开 [https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?uid=0&type=8](https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?uid=0&type=8)\n2.  打开控制台，切换到 Network 面板，刷新\n3.  点击 dynamic_new 请求，找到 Cookie\n4.  视频和专栏，UP 主粉丝及关注只要求 `SESSDATA` 字段，动态需复制整段 Cookie"}],requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},radar:[{source:[`space.bilibili.com/:uid`],target:`/user/dynamic/:uid`}],name:`UP 主动态`,maintainers:[`DIYgod`,`zytomorrow`,`CaoMeiYouRen`,`JimenezLi`],handler:b},f=e=>{let t=e.module_dynamic?.major;if(!t)return``;if(t.none)return t.none.tips;if(t.courses)return`${t.courses?.title} - ${t.courses?.sub_title}`;if(t.live_rcmd?.content)return JSON.parse(t.live_rcmd.content)?.live_play_info?.title;let n=t.type.replace(`MAJOR_TYPE_`,``).toLowerCase();return t[n]?.title},p=e=>{let t=``;e.module_dynamic?.desc?.text&&(t+=e.module_dynamic.desc.text);let n=e.module_dynamic?.major;if(!n)return t;if(n?.common?.desc)return t+=t?`<br>//转发自: ${n.common.desc}`:n.common.desc,t;if(n?.live)return`${n.live?.desc_first}<br>${n.live?.desc_second}`;if(n.live_rcmd?.content){let e=JSON.parse(n.live_rcmd.content)?.live_play_info;return`${e?.area_name}·${e?.watched_show?.text_large}`}if(n?.opus)return n?.opus?.summary?.text;let r=n.type.replace(`MAJOR_TYPE_`,``).toLowerCase();return n[r]?.desc},m=e=>e&&f(e),h=e=>e&&p(e),g=e=>e?.module_author?.name,_=(e,t=!0)=>{if(!t)return``;let n=e?.module_dynamic?.major?.archive?.aid,r=e?.module_dynamic?.major?.archive?.bvid;return n===void 0&&r===void 0?``:c.renderUGCDescription(t,``,``,n,void 0,r)},v=e=>{let t=[],n=e?.module_dynamic?.major;if(!n)return``;n.opus?.pics?.length&&t.push(...n.opus.pics.map(e=>e.url)),n.article?.covers?.length&&t.push(...n.article.covers),n.draw?.items?.length&&t.push(...n.draw.items.map(e=>e.src)),n.live_rcmd?.content&&t.push(JSON.parse(n.live_rcmd.content)?.live_play_info?.cover);let r=n.type.replace(`MAJOR_TYPE_`,``).toLowerCase();return n[r]?.cover&&t.push(n[r].cover),t.filter(Boolean).map(e=>`<img src="${e}">`).join(``)},y=(e,t=!1)=>{let n=e?.modules;if(!n)return null;let r=``,i=``,a,c=n.module_dynamic?.major;if(!c)return null;switch(c?.type){case`MAJOR_TYPE_UGC_SEASON`:r=c?.ugc_season?.jump_url||``,i=`合集地址：<a href=${r}>${r}</a>`;break;case`MAJOR_TYPE_ARTICLE`:r=`https://www.bilibili.com/read/cv${c?.article?.id}`,i=`专栏地址：<a href=${r}>${r}</a>`;break;case`MAJOR_TYPE_ARCHIVE`:{let e=c?.archive,n=t?`av${e?.aid}`:e?.bvid;r=`https://www.bilibili.com/video/${n}`,i=`视频地址：<a href=${r}>${r}</a>`,a=s(e?.bvid);break}case`MAJOR_TYPE_COMMON`:r=c?.common?.jump_url||``,i=`地址：<a href=${r}>${r}</a>`;break;case`MAJOR_TYPE_OPUS`:e?.type===`DYNAMIC_TYPE_ARTICLE`?(r=`https:${c?.opus?.jump_url}`,i=`专栏地址：<a href=${r}>${r}</a>`):e?.type===`DYNAMIC_TYPE_DRAW`&&(r=`https:${c?.opus?.jump_url}`,i=`图文地址：<a href=${r}>${r}</a>`);break;case`MAJOR_TYPE_PGC`:{let e=c?.pgc;r=`https://www.bilibili.com/bangumi/play/ep${e?.epid}&season_id=${e?.season_id}`,i=`剧集地址：<a href=${r}>${r}</a>`;break}case`MAJOR_TYPE_COURSES`:r=`https://www.bilibili.com/cheese/play/ss${c?.courses?.id}`,i=`课程地址：<a href=${r}>${r}</a>`;break;case`MAJOR_TYPE_MUSIC`:r=`https://www.bilibili.com/audio/au${c?.music?.id}`,i=`音频地址：<a href=${r}>${r}</a>`;break;case`MAJOR_TYPE_LIVE`:r=`https://live.bilibili.com/${c?.live?.id}`,i=`直播间地址：<a href=${r}>${r}</a>`;break;case`MAJOR_TYPE_LIVE_RCMD`:{let e=JSON.parse(c.live_rcmd?.content||`{}`)?.live_play_info;r=`https://live.bilibili.com/${e?.room_id}`,a=o(e?.room_id),i=`直播间地址：<a href=${r}>${r}</a>`;break}default:return null}return{url:r,text:i,videoPageUrl:a}};async function b(r){let o=r.req.param(`uid`),s=Object.fromEntries(new URLSearchParams(r.req.param(`routeParams`))),d=i(void 0,a(s.showEmoji),!1),b=i(void 0,a(s.embed),!0),x=r.req.query(`mode`)===`fulltext`,S=i(void 0,s.offset,``),C=i(void 0,a(s.useAvid),!1),w=i(void 0,a(s.directLink),!1),T=i(void 0,a(s.hideGoods),!1),E=await l.getCookie(),D=c.addDmVerifyInfo(`offset=${S}&host_mid=${o}&platform=web&features=itemOpusStyle,listOnlyfans,opusBigCover,onlyfansVote`,c.getDmImgList()),O=await n(`https://api.bilibili.com/x/polymer/web-dynamic/v1/feed/space?${D}`,{headers:{Referer:`https://space.bilibili.com/${o}/`,Cookie:E}}),k=u.parse(O.body);if(k?.code===-352)throw Error(`Request failed, please try again.`);let A=k?.data?.items,j=await l.getUsernameAndFaceFromUID(o),M=j[0]??A[0]?.modules?.module_author?.name,N=j[1]??A[0]?.modules?.module_author?.face;e.set(`bili-username-from-uid-${o}`,M),e.set(`bili-userface-from-uid-${o}`,N);let P=await Promise.all(A.filter(e=>T?e.modules.module_dynamic?.additional?.type!==`ADDITIONAL_TYPE_GOODS`:!0).map(async e=>{let n=e.modules,r=e?.orig?.modules,i=``;e.id_str&&(i=`https://t.bilibili.com/${e.id_str}`);let a=p(n)||``,s=f(n)||a,c=[];if(n.module_dynamic?.desc?.rich_text_nodes?.length){let e=n.module_dynamic.desc.rich_text_nodes;for(let t of e){if(d&&t?.emoji){let e=t.emoji;a=a.replaceAll(e.text,`<img alt="${e.text}" src="${e.icon_url}" style="margin: -1px 1px 0px; display: inline-block; width: 20px; height: 20px; vertical-align: text-bottom;" title="" referrerpolicy="no-referrer">`)}if(t?.pics?.length){let{pics:e,text:n}=t;a=a.replaceAll(n,e.map(e=>`<img alt="${n}" src="${e.src}" style="margin: 0px 0px 0px; display: inline-block; width: ${e.width}px; height: ${e.height}px; vertical-align: text-bottom;" title="" referrerpolicy="no-referrer">`).join(`<br>`))}t?.type===`RICH_TEXT_NODE_TYPE_TOPIC`&&c.push(t.text.match(/#(\S+)#/)?.[1]||``)}}if(n.module_dynamic?.major?.opus?.summary?.rich_text_nodes?.length){let e=n.module_dynamic.major.opus.summary.rich_text_nodes;for(let t of e)t?.type===`RICH_TEXT_NODE_TYPE_TOPIC`&&c.push(t.text.match(/#(\S+)#/)?.[1]||``)}if(n.module_dynamic?.topic?.name&&c.push(n.module_dynamic.topic.name),e.type===`DYNAMIC_TYPE_ARTICLE`&&x){let e=n.module_dynamic?.major?.opus?.jump_url?.match?.(/cv(\d+)/)?.[0];e&&(a=(await l.getArticleDataFromCvid(e,o)).description||``)}let u=y(e,C),S=u?.text;u&&w&&(i=u.url);let T=y(e?.orig,C),E=T?.text;T&&w&&(i=T.url);let D=``,O=g(r),k=m(r),A=h(r);O&&(D+=`//转发自: @${g(r)}: `),k&&(D+=k),A&&(D+=`<br>${A}`),a=a.replaceAll(`\r
`,`<br>`).replaceAll(`
`,`<br>`),D=D.replaceAll(`\r
`,`<br>`).replaceAll(`
`,`<br>`);let j=[a,_(n,b),v(n),S,D,_(r,b),v(r),E].map(e=>e?.trim()).filter(Boolean).join(`<br>`);return{title:s,description:j,pubDate:n.module_author?.pub_ts?t(n.module_author.pub_ts,`X`):void 0,link:i,author:M,category:c.length?[...new Set(c)]:void 0,attachments:u?.videoPageUrl||T?.videoPageUrl?[{url:u?.videoPageUrl||T?.videoPageUrl,mime_type:`text/html`}]:void 0}}));return{title:`${M} 的 bilibili 动态`,link:`https://space.bilibili.com/${o}/dynamic`,description:`${M} 的 bilibili 动态`,image:N,logo:N,icon:N,item:P}}export{d as route};