import{config as e}from"./config-DYqAlsU3.js";import{logger_default as t}from"./logger-BlLSmUdl.js";import"./proxy-kot7LoOQ.js";import{cache_default as n}from"./cache-7MGQxbL-.js";import"./parse-date-B2cCVoGk.js";import{invalid_parameter_default as r}from"./invalid-parameter-0LlYSQjk.js";import{ViewType as i}from"./types-DygLf1a3.js";import{fallback as a,queryToBoolean as o}from"./readable-social-Dld9apEb.js";import{puppeteer_default as s}from"./puppeteer-BJ-mUzln.js";import{ofetch as c}from"ofetch";import{load as l}from"cheerio";import u from"querystring";const d=e=>({Accept:`text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7`,"Accept-Encoding":`gzip, deflate, br`,"Accept-Language":`en-US,en;q=0.9`,"Cache-Control":`no-cache`,Connection:`keep-alive`,Host:`www.xiaohongshu.com`,Pragma:`no-cache`,"Sec-Ch-Ua":`"Chromium";v="122", "Not(A:Brand";v="24", "Google Chrome";v="122"`,"Sec-Ch-Ua-Mobile":`?0`,"Sec-Ch-Ua-Platform":`"Windows"`,"Sec-Fetch-Dest":`document`,"Sec-Fetch-Mode":`navigate`,"Sec-Fetch-Site":`none`,"Sec-Fetch-User":`?1`,"Upgrade-Insecure-Requests":`1`,"User-Agent":`Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36`,...e?{Cookie:e}:{}}),f=(n,r)=>r.tryGet(n,async()=>{let e=await s({stealth:!0});try{let r=await e.newPage();await r.setRequestInterception(!0);let i=``;r.on(`request`,e=>{e.resourceType()===`document`||e.resourceType()===`script`||e.resourceType()===`xhr`||e.resourceType()===`other`?e.continue():e.abort()}),t.http(`Requesting ${n}`),await r.goto(n,{waitUntil:`domcontentloaded`}),await r.waitForSelector(`div.reds-tab-item:nth-child(2)`);let a=await r.evaluate(()=>window.__INITIAL_STATE__);if(!await r.$(`.lock-icon`)){await r.click(`div.reds-tab-item:nth-child(2)`);try{let e=await r.waitForResponse(e=>{let t=e.request();return t.url().includes(`/api/sns/web/v2/note/collect/page`)&&t.method()===`GET`&&t.resourceType()===`xhr`},{timeout:5e3});i=await e.json()}catch{}}let{userPageData:o,notes:s}=a.user;return o=o._rawValue||o,s=s._rawValue||s,{userPageData:o,notes:s,collect:i}}finally{await e.close()}},e.cache.routeExpire,!1);async function p(e,t,n){let r=[],i=e.flatMap(e=>e.map(async({noteCard:e,id:r})=>{let i=`${t}/${r}`,{title:a,description:o,pubDate:s}=await m(i,n);return{title:a,link:i,description:o,author:e.user.nickName,guid:e.noteId,pubDate:s}}));return r.push(...await Promise.all(i)),r}async function m(t,r){let i=await n.tryGet(t,async()=>{let n=await c(t,{headers:d(e.xiaohongshu.cookie)}),i=l(n),a=g(i),o=JSON.parse(a),s=o.note.noteDetailMap[o.note.firstNoteId].note,u=s.title,f=s.desc;f=f.replaceAll(/\[.*?\]/g,``),f=f.replaceAll(/#(.*?)#/g,`#$1`),f=f.replaceAll(`
`,`<br>`);let p=new Date(s.time),m=``;if(s.type===`video`){let e=s.video?.consumer?.originVideoKey,t=[];e&&t.push(`http://sns-video-al.xhscdn.com/${e}`);let n=[`av1`,`h264`,`h265`,`h266`];for(let e of n){let n=s.video?.media?.stream?.[e];if(n?.length>0){let e=n[0];e.masterUrl&&t.push(e.masterUrl),e.backupUrls?.length&&t.push(...e.backupUrls)}}let r=s.imageList?.[0]?.urlDefault;t.length>0&&(m=`<video controls ${r?`poster="${r}"`:``}>
                    ${t.map(e=>`<source src="${e}" type="video/mp4">`).join(`
`)}
                </video><br>`)}else m=s.imageList.map(e=>{if(e.livePhoto&&r){let t=[],n=[`av1`,`h264`,`h265`,`h266`];for(let r of n){let n=e.stream?.[r];n?.length>0&&(n[0].masterUrl&&t.push(n[0].masterUrl),n[0].backupUrls?.length&&t.push(...n[0].backupUrls))}if(t.length>0)return`<video controls poster="${e.urlDefault}">
                            ${t.map(e=>`<source src="${e}" type="video/mp4">`).join(`
`)}
                        </video>`}return`<img src="${e.urlDefault}">`}).join(`<br>`);let h=`${m}<br>${u}<br>${f}`;return{title:u,description:h,pubDate:p}});return i}async function h(e,t){let n=await c(e,{headers:d(t)}),r=l(n),i=r(`#userPostedFeeds > section > div > a.cover.ld.mask`).map((e,t)=>t.attributes[3].value),a=g(r),o=JSON.parse(a),s=0;for(let e of o.user.notes.flat()){let t=i[s];t&&t.includes(`?`)&&(e.id+=t?.substring(t.indexOf(`?`))),s+=1}return o.user}function g(e){let t=e(`script`).filter((e,t)=>{let n=t.children[0]?.data;return n?.startsWith(`window.__INITIAL_STATE__=`)}).text();return t=t.slice(25),t=t.replaceAll(`undefined`,`null`),t}const _={path:`/user/:user_id/:category/:routeParams?`,name:`用户笔记/收藏`,categories:[`social-media`,`popular`],view:i.Articles,maintainers:[`lotosbin`,`howerhe`,`rien7`,`dddaniel1`,`pseudoyu`],handler:v,radar:[{source:[`xiaohongshu.com/user/profile/:user_id`],target:`/user/:user_id/notes`}],example:`/xiaohongshu/user/593032945e87e77791e03696/notes`,features:{antiCrawler:!0,requirePuppeteer:!0,requireConfig:[{name:`XIAOHONGSHU_COOKIE`,optional:!0,description:`小红书 cookie 值，可在网络里面看到。`}]},parameters:{user_id:`user id, length 24 characters`,category:{description:`category, notes or collect`,options:[{value:`notes`,label:`notes`},{value:`collect`,label:`collect`}],default:`notes`},routeParams:{description:"displayLivePhoto,`/user/:user_id/notes/displayLivePhoto=0`,不限时LivePhoto显示为图片,`/user/:user_id/notes/displayLivePhoto=1`,取值不为0时LivePhoto显示为视频",default:`0`}}};async function v(t){let n=t.req.param(`user_id`),r=t.req.param(`category`),i=u.parse(t.req.param(`routeParams`)),s=!!a(void 0,o(i.displayLivePhoto),!1),c=`https://www.xiaohongshu.com/user/profile/${n}`,l=e.xiaohongshu.cookie;if(l&&r===`notes`)try{let e=`https://www.xiaohongshu.com/explore`,t=await h(c,l),n=await p(t.notes,e,s);return{title:`${t.userPageData.basicInfo.nickname} - 笔记 • 小红书 / RED`,description:t.userPageData.basicInfo.desc,image:t.userPageData.basicInfo.imageb||t.userPageData.basicInfo.images,link:c,item:n}}catch{return await y(c,r)}else return await y(c,r)}async function y(e,t){let{userPageData:{basicInfo:i,interactions:a,tags:o},notes:s,collect:c}=await f(e,n),l=`${i.nickname} - 小红书${t===`notes`?`笔记`:`收藏`}`,u=`${i.desc} ${o.map(e=>e.name).join(` `)} ${a.map(e=>`${e.count} ${e.name}`).join(` `)}`,d=i.imageb||i.images,p=t=>t.flatMap(t=>t.map(({id:t,noteCard:n})=>({title:n.displayTitle,link:new URL(n.noteId||t,e).toString(),guid:n.noteId||t||n.displayTitle,description:`<img src ="${n.cover.infoList.pop().url}"><br>${n.displayTitle}`,author:n.user.nickname,upvotes:n.interactInfo.likedCount}))),m=t=>{if(!t)throw new r(`该用户已设置收藏内容不可见`);if(t.code!==0)throw Error(JSON.stringify(t));if(!t.data.notes.length)throw new r(`该用户已设置收藏内容不可见`);return t.data.notes.map(t=>({title:t.display_title,link:`${e}/${t.note_id}`,description:`<img src ="${t.cover.info_list.pop().url}"><br>${t.display_title}`,author:t.user.nickname,upvotes:t.interact_info.likedCount}))};return{title:l,description:u,image:d,link:e,item:t===`notes`?p(s):m(c)}}export{_ as route};