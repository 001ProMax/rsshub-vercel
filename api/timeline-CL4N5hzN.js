import"./esm-shims-CtP6w_ML.js";import{config as e}from"./config-DYqAlsU3.js";import"./logger-BlLSmUdl.js";import{ofetch_default as t}from"./ofetch-CDAeBYLA.js";import{parseDate as n}from"./parse-date-B2cCVoGk.js";import{invalid_parameter_default as r}from"./invalid-parameter-0LlYSQjk.js";import{ViewType as i}from"./types-DygLf1a3.js";import{rss_parser_default as a}from"./rss-parser-CSgwUI7l.js";import{config_not_found_default as o}from"./config-not-found-DTjmIGAO.js";const s={path:`/timeline/:account`,categories:[`social-media`,`popular`],view:i.SocialMedia,example:`/fediverse/timeline/Mastodon@mastodon.social`,parameters:{account:`username@domain`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`Timeline`,maintainers:[`DIYgod`,`pseudoyu`],handler:u},c=new Set([`mastodon.social`,`pawoo.net`,e.mastodon.apiHost].filter(Boolean)),l=new Set([`application/activity+json`,`application/ld+json; profile="https://www.w3.org/ns/activitystreams"`]);async function u(i){let s=i.req.param(`account`),u=s.split(`@`)[1],d=s.split(`@`)[0];if(!u||!d)throw new r(`Invalid account`);if(!e.feature.allow_user_supply_unsafe_domain&&!c.has(u.toLowerCase()))throw new o(`This RSS is disabled unless 'ALLOW_USER_SUPPLY_UNSAFE_DOMAIN' is set to 'true'.`);let f={headers:{Accept:`application/ld+json; profile="https://www.w3.org/ns/activitystreams"`}},p=await t(`https://${u}/.well-known/webfinger?resource=acct:${s}`,{headers:{Accept:`application/jrd+json`}}),m=p.links.find(e=>e.rel===`self`&&l.has(e.type))?.href,h=p.links.find(e=>e.rel===`http://webfinger.net/rel/profile-page`)?.href,g=await a.parseURL(`${h}.rss`);if(g)return{title:`${g.title} (Fediverse@${s})`,description:g.description,image:g.image?.url,link:g.link,item:g.items.map(e=>({title:e.title,description:e.content,link:e.link,pubDate:e.pubDate?n(e.pubDate):null,guid:e.guid}))};let _=await t(m,f),v=await t(_.outbox,f),y=await t(v.first,f),b=y.orderedItems,x=[];for(let e of b){if(![`Announce`,`Create`,`Update`].includes(e.type))continue;typeof e.object==`string`?x.push((async e=>(e.object=await t(e.object,f),e))(e)):x.push(Promise.resolve(e))}let S=await Promise.all(x);return{title:`${_.name||_.preferredUsername} (Fediverse@${s})`,description:_.summary,image:_.icon?.url||_.image?.url,link:h,item:S.map(e=>({title:e.object.content.replaceAll(/<[^<]*>/g,``),description:`${e.object.content}\n${e.object.attachment?.map(e=>`<img src="${e.url}" width="${e.width}" height="${e.height}" />`).join(`
`)||``}`,link:e.object.url,pubDate:n(e.published),guid:e.id}))}}export{s as route};