import{config as e}from"./config-DYqAlsU3.js";import{logger_default as t}from"./logger-BlLSmUdl.js";import{cache_default as n}from"./cache-7MGQxbL-.js";import{got_default as r}from"./got-Cw4D6IS5.js";import{utils_default as i}from"./utils-DBHllTyA.js";import{puppeteer_default as a}from"./puppeteer-BJ-mUzln.js";import{load as o}from"cheerio";import{JSDOM as s}from"jsdom";const c=!1,l=()=>{if(!c&&Object.keys(e.bilibili.cookies).length>0){for(let t of Object.keys(e.bilibili.cookies)){let n=e.bilibili.cookies[t];if(n){let r=n.replace(/b_lsid=[0-9A-F]+_[0-9A-F]+/,`b_lsid=${i.lsid()}`);e.bilibili.cookies[t]=r}}return e.bilibili.cookies[Object.keys(e.bilibili.cookies)[Math.floor(Math.random()*Object.keys(e.bilibili.cookies).length)]]}let r=`bili-cookie`;return n.tryGet(r,async()=>{let e=await a({stealth:!0}),n=await e.newPage(),r=new Promise(e=>{n.on(`requestfinished`,async t=>{if(t.url()===`https://api.bilibili.com/x/internal/gaia-gateway/ExClimbWuzhi`){let t=await n.cookies(),r=t.map(e=>`${e.name}=${e.value}`).join(`; `);r=r.replace(/b_lsid=[0-9A-F]+_[0-9A-F]+/,`b_lsid=${i.lsid()}`),e(r)}})});await n.goto(`https://space.bilibili.com/1/dynamic`);let o=await r;return t.debug(`Got bilibili cookie: ${o}`),await e.close(),o})},u=e=>{let t=`bili-web-render-data`;return n.tryGet(t,async()=>{let t=await l(),{data:n}=await r(`https://space.bilibili.com/${e}`,{headers:{Referer:`https://www.bilibili.com/`,Cookie:t}}),i=new s(n),a=i.window.document,o=a.querySelector(`#__RENDER_DATA__`),c=o&&o.textContent||`{}`,u=JSON.parse(decodeURIComponent(c)),d=u.access_id;return d})},d=()=>{let e=`bili-wbi-verify-string`;return n.tryGet(e,async()=>{let e=await l(),{data:t}=await r(`https://api.bilibili.com/x/web-interface/nav`,{headers:{Referer:`https://www.bilibili.com/`,Cookie:e}}),n=t.data.wbi_img.img_url,i=t.data.wbi_img.sub_url,a=n.substring(n.lastIndexOf(`/`)+1,n.length).split(`.`)[0]+i.substring(i.lastIndexOf(`/`)+1,i.length).split(`.`)[0],o=`https://s1.hdslb.com/bfs/seed/laputa-header/bili-header.umd.js`,{body:s}=await r(o,{headers:{Referer:`https://space.bilibili.com/1`}}),c=JSON.parse(s.match(/\[(?:\d+,){63}\d+]/)),u=[];for(let e of c)a.charAt(e)&&u.push(a.charAt(e));return u.join(``).slice(0,32)})},f=e=>{let t=`bili-username-from-uid-`+e;return n.tryGet(t,async()=>{let t=await l(),n=await d(),a=i.addWbiVerifyInfo(`mid=${e}&token=&platform=web&web_location=1550101`,n),{data:o}=await r(`https://api.bilibili.com/x/space/wbi/acc/info?${a}`,{headers:{Referer:`https://space.bilibili.com/${e}/`,Cookie:t}});return o.data?o.data.name:void 0})},p=async e=>{let a=`bili-username-from-uid-`+e,o=`bili-userface-from-uid-`+e,s=await n.get(a),c=await n.get(o);if(!s||!c){let f=await l(),p=await d(),m=i.getDmImgList(),h=await u(e),g=i.addWbiVerifyInfo(i.addRenderData(i.addDmVerifyInfo(`mid=${e}&token=&platform=web&web_location=1550101`,m),h),p),{data:_}=await r(`https://api.bilibili.com/x/space/wbi/acc/info?${g}`,{headers:{Referer:`https://space.bilibili.com/${e}/`,Cookie:f}});_.data.name?(s=_.data.name,c=_.data.face):t.error(`Error when visiting /x/space/wbi/acc/info: ${JSON.stringify(_)}`),n.set(a,s),n.set(o,c)}return[s,c]},m=e=>{let t=`bili-liveID-from-shortID-${e}`;return n.tryGet(t,async()=>{let{data:t}=await r(`https://api.live.bilibili.com/room/v1/Room/room_init?id=${e}`,{headers:{Referer:`https://live.bilibili.com/${e}`}});return t.data.room_id})},h=e=>{let t=`bili-userinfo-from-liveID-${e}`;return n.tryGet(t,async()=>{let{data:t}=await r(`https://api.live.bilibili.com/live_user/v1/UserInfo/get_anchor_in_room?roomid=${e}`,{headers:{Referer:`https://live.bilibili.com/${e}`}});return t.data.info})},g=(e,t)=>{let i=`bili-videoname-from-id-${t||e}`;return n.tryGet(i,async()=>{let{data:n}=await r(`https://api.bilibili.com/x/web-interface/view`,{searchParams:{aid:e||void 0,bvid:t||void 0},referer:`https://www.bilibili.com/video/${t||`av${e}`}`});return n.data.title})},_=(e,t,i)=>{let a=`bili-cid-from-id-${i||e}-${t}`;return n.tryGet(a,async()=>{let{data:n}=await r(`https://api.bilibili.com/x/web-interface/view?${i?`bvid=${i}`:`aid=${e}`}`,{referer:`https://www.bilibili.com/video/${i||`av${e}`}`});return n.data.pages[t-1].cid})},v=async e=>{let t=`bili-cid-from-bvid-${e}`,i=await n.get(t);if(!i){let a=await r(`https://api.bilibili.com/x/web-interface/view?bvid=${e}`,{headers:{Referer:`https://www.bilibili.com/video/${e}`}});a.data&&a.data.data&&a.data.data.aid&&(i=a.data.data.aid),n.set(t,i)}return i},y=async(e,t)=>{let i=`https://www.bilibili.com/read/cv${e}/`,a=await n.tryGet(i,async()=>(await r({method:`get`,url:i,headers:{Referer:`https://space.bilibili.com/${t}/`}})).data),s=o(a),c=s(`#read-article-holder`).html();if(!c)try{let e=JSON.parse(s(`script:contains("window.__INITIAL_STATE__")`).text().match(/window\.__INITIAL_STATE__\s*=\s*(.*?);\(/)[1]);if(e?.readInfo?.opus?.content?.paragraphs){c=``;for(let t of e.readInfo.opus.content.paragraphs){if(t.para_type===1)for(let e of t.text.nodes)e?.word?.words&&(c+=`<p>${e.word.words}</p>`);if(t.para_type===2)for(let e of t.pic.pics)c+=`<p ><img src="${e.url}@progressive.webp"></p>`;t.para_type===3&&t.line?.pic?.url&&(c+=`<figure><img src="${t.line.pic.url}"></figure>`)}}}catch{}return{url:i,description:c}};var b={getCookie:l,getWbiVerifyString:d,getUsernameFromUID:f,getUsernameAndFaceFromUID:p,getLiveIDFromShortID:m,getUserInfoFromLiveID:h,getVideoNameFromId:g,getCidFromId:_,getAidFromBvid:v,getArticleDataFromCvid:y,getRenderData:u};export{b as cache_default$1};