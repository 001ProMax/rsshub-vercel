import"./esm-shims-CtP6w_ML.js";import"./config-DYqAlsU3.js";import{logger_default as e}from"./logger-BlLSmUdl.js";import{ofetch_default as t}from"./ofetch-CDAeBYLA.js";import"./helpers-RrXnNmv1.js";import{cache_default as n}from"./cache-7MGQxbL-.js";import{parseDate as r}from"./parse-date-B2cCVoGk.js";import{got_default as i}from"./got-Cw4D6IS5.js";import{load as a}from"cheerio";var o=class extends Error{constructor(e){super(e),this.name=`WeChatMpError`}};const s=[`@Rongronggg9`],c=(...e)=>`wechat-mp: ${e.join(`: `)}`,l=(...e)=>`${c(...e)}
Consider raise an issue (mentioning ${s.join(`, `)}) with the article URL for further investigation`;let u=(...t)=>e.warn(l(...t));const d=(...t)=>{let n=l(...t);throw e.error(n),new o(n)},f=(...t)=>{let n=c(...t);throw e.error(n),new o(n)},p=(()=>{let e=(...e)=>d(`WarningAsError`,...e),t=u;return n=>{u=n?e:t}})(),m=(()=>{let e=/\r|\\(r|x0d)/g,t=/\n|\\(n|x0a)/g;return(n,r=``,i=`<br>`)=>n.replaceAll(e,r).replaceAll(t,i)})(),h=(()=>{let e=/(&|\\x26)amp;/g;return t=>t.replaceAll(e,`&`)})();var g=class extends Error{constructor(){super(``),this.name=`LoopContinue`}},_=class extends Error{to_return;constructor(e){super(``),this.name=`LoopReturn`,this.to_return=e}};const v=(e,t,n=null,r=`script[nonce][type="text/javascript"]`)=>{let i=typeof e==`string`?[e]:e(r).toArray();for(let e of i)try{t(e)}catch(e){if(e instanceof _)return e.to_return;if(e instanceof g)continue;throw e}return n},y={APP_MSG_PAGE:`0`,VIDEO_SHARE_PAGE:`5`,MUSIC_SHARE_PAGE:`6`,AUDIO_SHARE_PAGE:`7`,IMG_SHARE_PAGE:`8`,TEXT_SHARE_PAGE:`10`,SHORT_CONTENT_PAGE:`17`},b=Object.fromEntries(Object.entries(y).map(([e,t])=>[t,e]));var x=class{static genAssignmentRegExp=(e,t,n)=>RegExp(`\\b${e}\\s*${n}\\s*(?<quote>["'])(?<value>${t})\\k<quote>`,`mg`);static genExtractFunc=(e,{valuePattern:t=String.raw`\w+`,assignPattern:n=`=`,allowNotFound:r=!1,multiple:i=!1})=>{let a=this.genAssignmentRegExp(e,t,n);return e=>{let t=[];for(let n of e.matchAll(a)){let e=n.groups?.value;if(!i)return e;t.push(e)}if(!r&&t.length===0)throw new g;return i?t:null}};static doExtract=(e,t)=>{let n={};for(let[r,i]of Object.entries(e))n[r]=i(t);return n._extractedFrom=t,n};static commonMetadataToBeExtracted={showType:this.genExtractFunc(`item_show_type`,{valuePattern:String.raw`\d+`}),realShowType:this.genExtractFunc(`real_item_show_type`,{valuePattern:String.raw`\d+`}),createTime:this.genExtractFunc(`ct`,{valuePattern:String.raw`\d+`,allowNotFound:!0}),sourceUrl:this.genExtractFunc(`msg_source_url`,{valuePattern:`https?://[^'"]*`,allowNotFound:!0})};static common=e=>v(e,t=>{let n=e(t).text(),r=this.doExtract(this.commonMetadataToBeExtracted,n),i=b[r.showType],a=b[r.realShowType];throw r.sourceUrl=r.sourceUrl&&h(r.sourceUrl),i?r.showType=i:u(`showType not found`,`item_show_type=${r.showType}`),a?r.realShowType=a:u(`realShowType not found`,`real_item_show_type=${r.realShowType}`),r.showType!==r.realShowType&&u(`showType mismatch`,`item_show_type=${r.showType}, real_item_show_type=${r.realShowType}`),new _(r)},{},`script[nonce][type="text/javascript"]:contains("real_item_show_type")`);static audioMetadataToBeExtracted={voiceId:this.genExtractFunc(`voiceid`,{assignPattern:`:`}),duration:this.genExtractFunc(`duration`,{valuePattern:String.raw`\d*`,assignPattern:`:`,allowNotFound:!0})};static audio=e=>v(e,t=>{let n=e(t).text(),r=this.doExtract(this.audioMetadataToBeExtracted,n);throw new _(r)},{},`script[nonce][type="text/javascript"]:contains("voiceid")`);static imgMetadataToBeExtracted={imgUrls:this.genExtractFunc(`cdn_url`,{valuePattern:`https?://[^'"]*`,assignPattern:`:`,multiple:!0})};static img=e=>v(e,t=>{let n=e(t).text(),r=this.doExtract(this.imgMetadataToBeExtracted,n);throw Array.isArray(r.imgUrls)&&(r.imgUrls=r.imgUrls.map(e=>h(e))),new _(r)},{},`script[nonce][type="text/javascript"]:contains("picture_page_info_list")`);static locationMetadataToBeExtracted={countryName:this.genExtractFunc(`countryName`,{valuePattern:`[^'"]*`,assignPattern:`:`}),provinceName:this.genExtractFunc(`provinceName`,{valuePattern:`[^'"]*`,assignPattern:`:`}),cityName:this.genExtractFunc(`cityName`,{valuePattern:`[^'"]*`,assignPattern:`:`})};static location=e=>v(e,t=>{let n=e(t).text(),r=this.doExtract(this.locationMetadataToBeExtracted,n);throw new _(r)},{},`script[nonce][type="text/javascript"]:contains("countryName")`)};const S=(e,t,n)=>{t=e(t);let r=e(e(`<${n} />`)),i=t.attr();for(let e in i)r.attr(e,i[e]);r.append(t.contents()),t.replaceWith(r)},C=e=>e(`#js_content`).text()?e(`#js_content`).text().length<80?e(`#js_content a`).attr(`href`):null:e(`#js_share_source`).attr(`data-url`),w=e=>`https://res.wx.qq.com/voice/getvoice?mediaid=${e}`,T=(e,t)=>`<audio controls src="${e}" title="${t}" style="width:100%"/>`,E=e=>{let t=new URLSearchParams({origin:`https://mp.weixin.qq.com`,containerId:`js_tx_video_container_0.3863487104715233`,vid:e,width:`677`,height:`380.8125`,autoplay:`false`,allowFullScreen:`true`,chid:`17`,full:`true`,show1080p:`false`,isDebugIframe:`false`});return`https://v.qq.com/txp/iframe/player.html?${t.toString()}`},D=(e,t=!1)=>{let n=``;if(typeof e==`string`?n=e:e?.html&&(n=e.html()||``),!n)return``;let r=a(n,void 0,!1);return t||r(`img[data-src]`).each((e,t)=>{let n=r(t),i=n.attr(`data-src`);i&&(n.attr(`src`,i),n.removeAttr(`data-src`))}),r(`mpvoice[voice_encode_fileid]`).each((e,t)=>{let n=r(t),i=n.attr(`voice_encode_fileid`);if(i){let e=n.attr(`name`)||`Audio`;n.replaceWith(T(w(i),e))}}),r(`iframe.video_iframe[data-src]`).each((e,t)=>{let n=r(t),i=n.attr(`data-src`),a=new URL(i);if(a.host===`v.qq.com`&&a.searchParams.has(`vid`)){let e=E(a.searchParams.get(`vid`));n.attr(`src`,e),n.removeAttr(`data-src`);let t=n.attr(`data-w`),r=n.attr(`data-ratio`);if(t&&r){let e=Math.min(Number.parseInt(t),677);n.attr(`width`,e.toString()),n.attr(`height`,(e/Number.parseFloat(r)).toString())}}}),r(`section`).each((e,t)=>{let n=r(t),i=n.find(`p`).length,a=n.find(`div`).length,o=n.find(`section`).length;i+a+o===0?S(r,t,`p`):S(r,t,`div`)}),r(`code`).each((e,t)=>{r(`<br>`).insertAfter(t)}),r(`.code-snippet__line-index`).remove(),r(`script`).remove(),r.html()},O=(e,t=!1)=>{let n=e;e=h(e);let r=new URL(e);if(!t&&r.host!==`mp.weixin.qq.com`&&d(`URL host must be "mp.weixin.qq.com"`,e),r.protocol=`https:`,r.hash=``,r.pathname.startsWith(`/s/`))r.search=``;else if(r.pathname===`/s`){let e=r.searchParams.get(`__biz`),t=r.searchParams.get(`mid`)||r.searchParams.get(`appmsgid`),i=r.searchParams.get(`idx`)||r.searchParams.get(`itemidx`),a=r.searchParams.get(`sn`)||r.searchParams.get(`sign`);if(e&&t&&i&&a)r.search=`?__biz=${e}&mid=${t}&idx=${i}&sn=${a}`;else{let e=r.searchParams.get(`src`),t=r.searchParams.get(`timestamp`),i=r.searchParams.get(`ver`),a=r.searchParams.get(`signature`);e&&t&&i&&a?r.search=`?src=${e}&timestamp=${t}&ver=${i}&signature=${a}`:u(`unknown URL search parameters`,n)}}else u(`unknown URL path`,n);return r.href};var k=class e{static common=(e,t)=>{let n=m(e(`meta[property="og:title"]`).attr(`content`)||``,``,` `),i=m(e(`meta[name=author]`).attr(`content`)||``,``,` `),a=t.createTime?r(Number.parseInt(t.createTime)*1e3):void 0,o=e(`.wx_follow_nickname`).first().text()?.trim(),s=m(e(`meta[name=description]`).attr(`content`)||``),c=s;return s=s.replaceAll(`<br>`,` `)===n?``:s,{title:n,author:i,description:c,summary:s,pubDate:a,mpName:o}};static appMsg=async(n,r)=>{let i=e.common(n,r);i.description=D(n(`#js_content`));let o=C(n);if(o){let e=await t(O(o)),n=a(e);i.description+=D(n(`#js_content`))}return i};static img=(t,n)=>{let r=e.common(t,n),i=x.img(t)?.imgUrls,a=``;if(Array.isArray(i)&&i.length>0)for(let e of i)a+=`<br><br><img src="${e}" />`;return r.description+=a,r};static audio=(t,n)=>{let r=e.common(t,n),i=x.audio(t),a=w(i.voiceId);return r.enclosure_url=a,r.itunes_duration=i.duration,r.enclosure_type=`audio/mp3`,r.description+=`<br><br>`+T(a,r.title),r};static fallback=(t,n)=>{let r=e.common(t,n),i=t(`meta[property="og:image"]`).attr(`content`);return i&&(r.description+=`<br><br><img src="${i}" />`),r};static dispatch=async(t,n)=>{let r=a(t),i=x.common(r),o,s,c;switch(i.showType){case`APP_MSG_PAGE`:o=await e.appMsg(r,i);break;case`AUDIO_SHARE_PAGE`:o=e.audio(r,i);break;case`IMG_SHARE_PAGE`:o=e.img(r,i);break;case`VIDEO_SHARE_PAGE`:o=e.fallback(r,i);break;case void 0:return r(`script, style`).remove(),s=r(`title, body`).text().replaceAll(/\s+/g,` `).trim(),c=s.slice(0,25),s.length>=28&&(c=s.slice(0,25),c+=`...`),s.includes(`已被发布者删除`)?f(`deleted by author`,c,n):new URL(n).pathname.includes(`captcha`)||s.includes(`环境异常`)?f(`request blocked by WAF`,c,n):d(`unknown page, probably due to WAF`,c,n),{};default:u(`new showType, trying fallback method`,`showType=${i.showType}`,n),o=e.fallback(r,i)}let l=x.location(r),p=``;for(let e of[l.countryName,l.provinceName,l.cityName])e&&(p+=e+` `);return p=p.trim(),p&&(o.description+=`<p>📍发表于：${p}</p>`),i.sourceUrl&&(o.description+=`<p><a href="${i.sourceUrl}">🔗️ 阅读原文</a></p>`),o}};const A=async(e,n=5)=>{n--;let r=await t.raw(e);return[301,302,303,307,308].includes(r.status)?(r.headers.has(`location`)?n<=0&&d(`too many redirects`,e):d(`redirect without location`,e),await A(r.headers.get(`location`),n)):r},j=(e,t=!1)=>(e=O(e,t),n.tryGet(e,async()=>{let t=await A(e),n=await k.dispatch(t._data,t.url);return{...n,link:e}})),M=async(e,t=!1,n=!1)=>{if(e.link){let r=await j(e.link);for(let i in r)switch(i){case`author`:e.author=t?r.mpName||e.author:r.author||e.author;break;case`link`:e.link=n?e.link:r.link||e.link;break;default:e[i]=e[i]||r[i]}}return e},N=`https://www.slowmist.com`,P={path:`/:type?`,categories:[`new-media`,`popular`],example:`/slowmist/research`,parameters:{type:`分类，见下表，默认为公司新闻`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},radar:[{source:[`slowmist.com/zh/news.html`]}],name:`动态`,maintainers:[`AtlasQuan`],handler:F,url:`slowmist.com/zh/news.html`,description:`| 公司新闻 | 漏洞披露 | 技术研究 |
| -------- | -------- | -------- |
| news     | vul      | research |`};async function F(e){let t=e.req.param(`type`),n=`慢雾科技 - `;switch(t){case`news`:n+=`公司新闻`;break;case`vul`:n+=`漏洞披露`;break;case`research`:n+=`技术研究`;break;default:t=`news`,n+=`公司新闻`}let a=`${N}/api/get_list?type=${t}`,o=await i(a),s=(o.data.data||[]).map(e=>({title:e.title,link:e.url,description:e.desc,pubDate:r(e.date)}));return s=await Promise.all(s.map(e=>M(e))),{title:n,link:a,item:s}}export{P as route};