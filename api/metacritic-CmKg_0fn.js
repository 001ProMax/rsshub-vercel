import{__dirname as e,init_esm_shims as t}from"./esm-shims-CtP6w_ML.js";import"./config-DYqAlsU3.js";import"./logger-BlLSmUdl.js";import"./ofetch-CWQqZcqz.js";import"./helpers-RrXnNmv1.js";import{art as n}from"./render-DE4LRFBD.js";import{parseDate as r}from"./parse-date-DHsdom8D.js";import{got_default as i}from"./got-BwctkUCD.js";import a from"node:path";import{load as o}from"cheerio";const s={metascore:{id:`metaScore`,name:`Metascore`},userscore:{id:`userScore`,name:`User Score`},popular:{id:`popularityCount`,name:`Most Popular`},new:{id:`releaseDate`,name:`Releases`}},c={game:{id:`games`,name:`Games`},movie:{id:`movies`,name:`Movies`},tv:{id:`tv`,name:`TV Shows`},albums:{id:`albums`,name:`Music`}};t();const l={path:`/:type?/:sort?/:filter?`,name:`Unknown`,maintainers:[],handler:u};async function u(t){let{type:l=`game`,sort:u=`new`,filter:d}=t.req.param(),f=t.req.query(`limit`)?Number.parseInt(t.req.query(`limit`),10):50,p=`https://www.metacritic.com`,m=`https://backend.metacritic.com`,h=new URL(`v1/xapi/finder/metacritic/web`,m).href,g=new URL(`/browse/${l}/all/all/all-time/${u}/${d?`?${d}`:``}`,p),_=g.searchParams,v=g.href,{data:y}=await i(v),b=y.match(/apiKey=(.*?)&/)[1],x={sortBy:`-${s[u].id}`,productType:c[l].id,limit:f,apiKey:b},S=_.getAll(`genre`).join(`,`).toLowerCase(),C=_.getAll(`releaseType`).join(`,`),w=_.get(`releaseYearMin`),T=_.get(`releaseYearMax`);S&&(x.genres=S),C&&(x.releaseType=C),w&&(x.releaseYearMin=w),T&&(x.releaseYearMax=T);let E=_.getAll(`platform`),D=_.getAll(`network`);if(E.length||D.length){let e={},t=String.raw`{label:"([^"]+)",value:(\d+),href:a,meta:{mcDisplayWeight`;for(let n of y.match(new RegExp(t,`g`))){let r=n.match(new RegExp(t));e[r[1].toLowerCase().split(/(\s\(|\\u002f(?!\s))/)[0].replaceAll(`-`,`---`).replaceAll(/\s\/\s/g,`-or-`).replaceAll(`+`,`-plus`).replaceAll(/\s/g,`-`)]=r[2]}E.length&&(x.gamePlatformIds=E.map(t=>Object.hasOwn(e,t)?e[t]:void 0).filter(Boolean).join(`,`)),D.length&&(x.streamingNetworkIds=D.map(t=>Object.hasOwn(e,t)?e[t]:void 0).filter(Boolean).join(`,`))}let{data:O}=await i(h,{searchParams:x}),k=O.data.items.slice(0,f).map(t=>({title:t.title,link:new URL(`${l}/${t.slug}`,p).href,description:n(a.join(e,`templates/description-dc1efad7.art`),{image:t.image?{src:new URL(`a/img/catalog${t.image.bucketPath}`,p).href,alt:t.image.alt}:void 0,description:t.description,score:t.criticScoreSummary?.score??void 0}),category:t.genres.map(e=>e.name),guid:`metacritic-${t.id}`,pubDate:r(t.releaseDate),upvotes:t.criticScoreSummary?.positiveCount?Number.parseInt(t.criticScoreSummary?.positiveCount,10):0,downvotes:t.criticScoreSummary?.negativeCount?Number.parseInt(t.criticScoreSummary?.negativeCount,10):0,comments:t.criticScoreSummary?.reviewCount?Number.parseInt(t.criticScoreSummary?.reviewCount,10):0})),A=o(y),j=new URL(A(`meta[data-hid="msapplication-task-metacritic"]`).prop(`content`).split(`icon-uri=`).pop(),p).href;return{item:k,title:A(`title`).text(),link:v,description:A(`meta[name="description"]`).prop(`content`),language:A(`html`).prop(`lang`),image:A(`link[rel="icon"]`).prop(`content`),icon:j,logo:j,subtitle:A(`meta[name="msapplication-tooltip"]`).prop(`content`),author:A(`meta[name="twitter:site"]`).prop(`content`),allowEmpty:!0}}export{l as route};