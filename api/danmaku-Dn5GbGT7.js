import"./esm-shims-CtP6w_ML.js";import"./config-DYqAlsU3.js";import"./logger-BlLSmUdl.js";import"./proxy-kot7LoOQ.js";import"./ofetch-CWQqZcqz.js";import"./helpers-RrXnNmv1.js";import"./cache-CvppK6AM.js";import"./render-DE4LRFBD.js";import"./md5-BJqXla8f.js";import{got_default as e}from"./got-BwctkUCD.js";import"./puppeteer-DQCLzTv0.js";import"./utils-CsTdEpjv.js";import{cache_default$1 as t}from"./cache-COOjRm1i.js";import n from"zlib";import{load as r}from"cheerio";const i=e=>{let t=Number.parseInt(e),n=t%60,r=(t-n)/60%60,i=(t-n-60*r)/3600;return`${i}:${r.toString().padStart(2,`0`)}:${n.toString().padStart(2,`0`)}`},a={path:`/video/danmaku/:bvid/:pid?`,categories:[`social-media`],example:`/bilibili/video/danmaku/BV1vA411b7ip/1`,parameters:{bvid:`视频AV号,可在视频页 URL 中找到`,pid:`分P号,不填默认为1`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`视频弹幕`,maintainers:[`Qixingchen`],handler:o};async function o(a){let o=a.req.param(`bvid`),s;o.startsWith(`BV`)||(s=o,o=null);let c=Number(a.req.param(`pid`)||1),l=50,u=await t.getCidFromId(s,c,o),d=await t.getVideoNameFromId(s,o),f=`https://www.bilibili.com/video/${o||`av${s}`}`,p=await e.get(`https://comment.bilibili.com/${u}.xml`,{decompress:!1,responseType:`buffer`,headers:{Referer:f}}),m=p.body;m=await((m[0]&15)==8?n.inflateSync(m):n.inflateRawSync(m));let h=[],g=r(m,{xmlMode:!0});return g(`d`).each((e,t)=>{h.push({p:g(t).attr(`p`),text:g(t).text()})}),h=h.reverse().slice(0,l),{title:`${d} 的 弹幕动态`,link:f,description:`${d} 的 弹幕动态`,item:h.map(e=>({title:`[${i(e.p.split(`,`)[0])}] ${e.text}`,pubDate:new Date(e.p.split(`,`)[4]*1e3).toUTCString(),guid:`${u}-${e.p.split(`,`)[4]}-${e.p.split(`,`)[7]}`,link:f}))}}export{a as route};